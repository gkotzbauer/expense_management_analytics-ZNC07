<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZNC07 Margin Performance Dashboard</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .upload-container h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .upload-container p {
            color: #718096;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-content p {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .upload-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #a0aec0 !important;
        }

        .sample-data-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .sample-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.2s ease;
        }

        .sample-btn:hover {
            transform: translateY(-2px);
        }

        .data-status {
            background: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #2f855a;
        }

        .data-status.error {
            background: #fed7d7;
            border-color: #fc8181;
            color: #c53030;
        }

        .filters-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .filter-group h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .multi-select {
            position: relative;
            min-height: 40px;
        }

        .multi-select-button {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .multi-select-button:hover {
            border-color: #667eea;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 999999;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f7fafc;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .insights-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .insight-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .export-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }

        .center-column {
            text-align: center !important;
        }

        .projection-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .projection-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .projection-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .projection-header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .projection-input-section {
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .input-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 ZNC07 Margin Performance Dashboard</h1>
            <p>Comprehensive margin insights to drive performance optimization and profitability management</p>

        </div>

        <!-- Financial Performance Overview Section -->
        <div class="insights-section">
            <h2>📊 Financial Performance Overview</h2>
            <p style="color: #718096; margin-bottom: 20px;">Performance analysis for Jan-July 2024 vs 2025</p>
            
            <!-- Key Metrics Summary -->
            <div style="margin-bottom: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Total Revenue</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="totalRevenue">$933K</p>
                                <!-- For Total Revenue -->
                                <div style="color: #38a169; font-size: 0.9rem; margin-top: 5px;" id="totalRevenueGrowth">
                                    <span style="margin-right: 5px;">↗</span>35%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #667eea;">💰</div>
                        </div>
                    </div>
                    
                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #48bb78;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Total Expenses</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="totalExpenses">$788K</p>
                                <!-- For Total Expenses -->
                                <div style="color: #e53e3e; font-size: 0.9rem; margin-top: 5px;" id="totalExpensesGrowth">
                                    <span style="margin-right: 5px;">↘</span>12%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #48bb78;">📊</div>
                        </div>
                    </div>

                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #805ad5;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Visit Count</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="visitCount">8,156</p>
                                <!-- For Visit Count -->
                                <div style="color: #38a169; font-size: 0.9rem; margin-top: 5px;" id="visitCountGrowth">
                                    <span style="margin-right: 5px;">↗</span>26%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #805ad5;">👥</div>
                        </div>
                    </div>

                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #ed8936;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Profit per Visit</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="profitPerVisit">$18</p>
                                <!-- For Profit per Visit -->
                                <div style="color: #38a169; font-size: 0.9rem; margin-top: 5px;" id="profitPerVisitGrowth">
                                    <span style="margin-right: 5px;">↗</span>156%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #ed8936;">💰</div>
                        </div>
                    </div>
                </div>

                <!-- YOY Expense & Profitability Analysis -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600;">YOY Expense & Profitability Analysis</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;" id="expenseAnalysisTable">
                            <thead style="background: #f7fafc;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Metric</th>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Responsibility</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2024 Jan-July</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2025 Jan-July</th>
                                    <th style="padding: 12px; text-align: center; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Growth</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">
                                        <div style="line-height: 1.1;">Absolute</div>
                                        <div style="line-height: 1.1;">Difference</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Remaining Year Cashflow Projections -->
                <div>
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600;">
                        <span style="margin-right: 10px;">📅</span>
                        Remaining Year Cashflow Projections
                    </h3>
                    <p style="color: #718096; margin-bottom: 20px; font-size: 0.9rem;">5-month projection based on current trends</p>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;" id="cashflowTable">
                            <thead style="background: #f7fafc;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Month</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2023/24 Visit Avg</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2025 Visit Projection</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Expenses</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Revenue</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Profit</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Cash Position</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATUS SUMMARY CHARTS -->
        <div class="insights-section" id="workingChartsSection">
            <h2>🎯 2025 Profit Performance</h2>
            <div style="display: flex; align-items: flex-start; gap: 20px; justify-content: flex-start;">
                <div style="width: 650px;">
                    <canvas id="workingRevenueChart" width="650" height="520"></canvas>
                </div>
                <div style="width: 650px;">
                    <canvas id="workingMarginChart" width="650" height="520"></canvas>
                </div>
            </div>
        </div>

        <!-- Key Insights Section -->
        <div id="dashboardContent" class="hidden">






            <div class="insights-section">
                <h2>🔍 Key Insights for Most Recent Month (July)</h2>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 20px; font-style: italic;">
                    <strong>Note:</strong> The metrics below show categories based on their expenses in July relative to their average spend over the entire dataset (14 months).
                </p>
                <div class="insight-item" id="expenseOutpacedInsight">
                    <span style="font-size: 1.2rem;">⚠️ </span>
                    <strong>Expenses Grew Faster Than GP:</strong> <span id="expenseOutpacedText">Loading...</span>
                </div>
                <div class="insight-item" id="expenseGrewDespiteDeclineInsight">
                    <span style="font-size: 1.2rem;">⚠️ </span>
                    <strong>Expenses Grew Even Though GP Declined:</strong> <span id="expenseGrewDespiteDeclineText">Loading...</span>
                </div>
                <div class="insight-item" id="topVarianceInsight">
                    <span style="font-size: 1.2rem;">📈 </span>
                                            <strong>Expenses in Most Recent Month with Highest Variance:</strong> <span id="topVarianceText">Loading...</span>
                </div>
                <div class="insight-item" id="marginInsight">
                    <span style="font-size: 1.2rem;">🏆 </span>
                    <strong>Top Performing Expense Categories with Controlled Cost (relative to change in revenue):</strong> <span id="topMarginText">Loading...</span>
                </div>
                <div class="insight-item" id="marketingROIInsight">
                    <span style="font-size: 1.2rem;">💰 </span>
                    <strong>Marketing Spend Efficiency:</strong> <span id="marketingROIText">Advertising & Marketing Fund (Inefficient, 0.06)</span>
                </div>

                
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Marketing Spend Efficiency</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Unclassified:</strong> Average marketing spend below $500 or missing data—unable to assess efficiency.</li>
                        <li><strong>Under-Leveraged:</strong> Marketing spend grew less than 80% of profit growth—likely room to increase investment.</li>
                        <li><strong>Efficient:</strong> Marketing spend growth tracked profit growth within ±20% (80–120%)—good ROI.</li>
                        <li><strong>Inefficient:</strong> Marketing spend grew more than 120% of profit growth—spend outpacing returns, needs review.</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 0.9rem; color: #718096; font-style: italic;">
                        <strong>Note:</strong> The value in parentheses behind the Marketing Spend Efficiency category is the ratio between the percentage change for the category and the percentage change for Gross Profit. A value close to 1.0 means the expense moved proportionally with GP. A value between 0 < ratio < 1 means the expense moved in the same direction as GP but by a smaller percentage (sticky cost; margin squeeze risk). A value >1 means the expense fell faster than GP (good cost alignment). A value <0 means the expense moved the wrong way (e.g., GP down, expense up). For example, a value of 0.06 means the category changed at 6% of the rate of Gross Profit.
                    </p>
                </div>
            </div>

            <div class="chart-container">
                <h2>📊 Margin Risk Assessment for Most Recent Month (July)</h2>
                <canvas id="performanceChart" width="400" height="300"></canvas>
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Margin Risk Assessment Definitions</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Margin Improvement:</strong> Expense reductions or better expense control relative to profit—expenses are declining, or increasing more slowly than profit, driving improved margins.</li>
                        <li><strong>Margin Risk:</strong> Expenses are rising faster than profit, or are increasing while profit is flat or declining. This expense appears to be threat to margins that warrants immediate investigation and action.</li>
                        <li><strong>Below Threshold:</strong> An expense category will be assigned "Below Threshold" if its average monthly expense is below $500 or if it's a one-time expense.</li>
                        <li><strong>Neutral:</strong> Expenses and profit are changing at similar rates, or neither cost nor profit are moving in a way that indicates significant risk or improvement. No immediate concern - keep under review.</li>
                    </ul>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>📋 Most Recent Month Key Insights <span id="recentMonthDisplay"></span></h2>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="window.dashboard.exportAllData()">📈 Export All Data</button>
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 15px; font-style: italic;">
                    <strong>Table Organization:</strong> Categories are ranked by Suggested Action, with Investigate - Potential Risk ranked first.
                </p>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 250px;">Category</th>
                            <th class="center-column" style="width: 200px;">Expenses for Most Recent Month</th>
                            <th class="center-column" style="width: 200px;">Most Recent Month vs. Avg. of Prior Months</th>
                            <th class="center-column">Expense Growth Alignment</th>
                            <th class="center-column">Suggested Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>📋 Expense Trends Over Entire Dataset (14 months)</h2>
                </div>
                <table id="growthRiskTable">
                    <thead>
                        <tr>
                            <th style="width: 180px;">Category</th>
                            <th class="center-column" style="width: 180px;"># of Months Outpaced Growth</th>
                            <th class="center-column" style="width: 220px;"># of Months Did Not Decline with Profit</th>
                            <th class="center-column" style="width: 220px;"># of Months Opposite Direction than Profit</th>
                            <th class="center-column" style="width: 220px;">Potential $ Loss Due to Excess Spending</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 24px; font-size: 0.9rem; color: #718096;">
                    <span style="font-weight: bold; color: #2d3748; font-size: 0.95rem;">Potential $ Loss Due to Excess Spending:</span>
                    <span style="color: #718096; font-size: 0.9rem;"> Excess cost is the amount by which an expense category's growth exceeds the growth in gross profit by more than 5%. For example, if gross profit rises by 5%, any portion of expense growth above 10% (5% profit increase + 5% buffer) is flagged as excess cost. If gross profit declines, expenses are expected to decline at least as much (plus 5%); any shortfall is counted as excess.</span>
                </div>
            </div>

            <div class="projection-container">
                <div class="projection-header">
                    <h2> Expense Projection Based on Gross Profit Forecast</h2>
                    <p>Enter an estimated gross profit to see projected expenses for each category</p>
                    <p style="font-size: 0.9rem; color: #718096; margin-top: 10px;">
                        <strong>Formula:</strong> Projected Expense = Fixed Cost Estimate + (Marginal Cost per $1 GP × Estimated Gross Profit)
                    </p>
                </div>
                
                <div class="projection-input-section">
                    <div class="input-group">
                        <label for="estimatedGP">Estimated Gross Profit for the Month ($)</label>
                        <input type="number" id="estimatedGP" value="147081" min="0" step="1000">
                    </div>
                    <button class="sample-btn" onclick="window.dashboard.calculateProjections()">Calculate Projections</button>
                </div>

                <div class="projection-summary">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="totalProjectedExpenses" style="color: #f56565; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Total Projected Expenses</p>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="projectedProfit" style="color: #48bb78; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Projected Profit</p>
                        </div>
                    </div>
                </div>

                <div class="projection-results">
                    <div class="table-header">
                        <h3>📊 Projected Expenses by Category</h3>
                        <div class="export-buttons">
                            <button class="export-btn secondary" onclick="window.dashboard.exportProjections()">📈 Export Projections</button>
                        </div>
                    </div>
                    <table id="projectionTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Fixed Cost Estimate</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="top-drivers">
                    <h3>🚀 Top Expense Categories Growing Fastest with Revenue</h3>
                    <table id="topDriversTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>

        
        window.dashboard = {
            originalData: [],
            filteredData: [],
            modelData: [],
            performanceChart: null,
            isInitialized: false,
            mostRecentMonthColumn: null, // Store the most recent month column name

            sampleData: [
                {
                    "Category": "Other",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R² Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk – Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 1
                },
                {
                    "Category": "Total Taxes",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R² Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk – Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 2
                },
                {
                    "Category": "Net Other Income/Expense",
                    "January": -3328.87,
                    "February": -4545.14,
                    "March": -3460.13,
                    "April": -10716.94,
                    "May": -4673.57,
                    "Nonzero Month Count": 5,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": -5344.93,
                    "R² Linear": 0.0181,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1215.905209574297,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": -5344.93,
                    "Reconciled Anchor Month Expense": -3237.716674753547,
                    "Estimated Future Expense": -5344.93,
                    "Mean Prior Months Expense": -5512.77,
                    "Mean All Months Expense": -5344.93,
                    "Anchor vs Prior Avg ($)": 839.2000000000007,
                    "Ratio_Change_Anchor_vs_MeanPrior": -0.1522283715808932,
                    "Expense vs Profit Growth Ratio": 0.06020386891180868,
                    "Expense Growth Alignment": "Costs Grew Slower than Profit",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 3
                },
                {
                    "Category": "Supplies/Giveaways",
                    "January": 1606.2,
                    "February": 0.0,
                    "March": 0.0,
                    "April": 0.0,
                    "May": 862.56,
                    "Nonzero Month Count": 2,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 493.7520000000001,
                    "R² Linear": 0.0,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 0.0,
                    "Model Status": "Insufficient-data",
                    "Estimated Anchor Month Expense": 493.7520000000001,
                    "Reconciled Anchor Month Expense": 299.0926136718186,
                    "Estimated Future Expense": 493.7520000000001,
                    "Mean Prior Months Expense": 401.55,
                    "Mean All Months Expense": 493.7520000000001,
                    "Anchor vs Prior Avg ($)": 461.0099999999999,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.148076204706761,
                    "Expense vs Profit Growth Ratio": -0.4540456460982601,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 4
                },
                {
                    "Category": "Physicians",
                    "January": 481.86,
                    "February": 0.0,
                    "March": 196.4,
                    "April": 193.22,
                    "May": 538.44,
                    "Nonzero Month Count": 4,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 281.984,
                    "R² Linear": 0.8292,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": -12.74300624680268,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 281.984,
                    "Reconciled Anchor Month Expense": 170.8131441971559,
                    "Estimated Future Expense": 281.984,
                    "Mean Prior Months Expense": 217.87,
                    "Mean All Months Expense": 281.984,
                    "Anchor vs Prior Avg ($)": 320.5700000000001,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.471382016799009,
                    "Expense vs Profit Growth Ratio": -0.5819078870687899,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 5
                },
                {
                    "Category": "Medical Waste Removal",
                    "January": 0.0,
                    "February": 0.0,
                    "March": 130.02,
                    "April": 130.02,
                    "May": 263.94,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 104.796,
                    "R² Linear": 0.462,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 60.2350312182221,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 104.796,
                    "Reconciled Anchor Month Expense": 63.48067358178174,
                    "Estimated Future Expense": 104.796,
                    "Mean Prior Months Expense": 65.01,
                    "Mean All Months Expense": 104.796,
                    "Anchor vs Prior Avg ($)": 198.93,
                    "Ratio_Change_Anchor_vs_MeanPrior": 3.059990770650669,
                    "Expense vs Profit Growth Ratio": -1.210177060389181,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 6
                }
            ],

            // Function to check if a category should be excluded from projections
            isExcludedFromProjections: function(categoryName) {
                const category = categoryName.toLowerCase().trim();
                
                // Exact exclusions (removed 'total expenses')
                const exactExclusions = [
                    'net operating income',
                    'total income',
                    'gross profit',
                    'net income',
                    'unapplied cash payment income'
                ];
                
                // Pattern exclusions (removed all)
                const patternExclusions = [];
                
                // New exclusion patterns (removed fee, fees, services-doctors, medical services)
                const newExclusions = [
                    'income',
                    'profit'
                ];
                
                // Check exact matches
                if (exactExclusions.includes(category)) {
                    return true;
                }
                
                // Check pattern matches (removed all pattern exclusions)
                for (let pattern of patternExclusions) {
                    if (category.includes(pattern)) {
                        return true;
                    }
                }
                
                // Check new exclusion patterns
                for (let pattern of newExclusions) {
                    if (category.includes(pattern)) {
                        console.log(`Excluding category "${categoryName}" due to pattern "${pattern}"`);
                        return true;
                    }
                }
                
                // Check if starts with "total" (removed this exclusion)
                // if (category.startsWith('total ')) {
                //     return true;
                // }
                
                return false;
            },

            init: function() {
                this.setupFileUpload();
                this.setupEventListeners();
            },

            setupFileUpload: function() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const useSampleDataBtn = document.getElementById('useSampleData');

                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.handleFileUpload(e.target.files[0]);
                        }
                    });

                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files.length > 0) {
                            this.handleFileUpload(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (useSampleDataBtn) {
                    useSampleDataBtn.addEventListener('click', () => {
                        this.loadSampleData();
                    });
                }
            },

            setupEventListeners: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                if (estimatedGPInput) {
                    estimatedGPInput.addEventListener('change', () => {
                        this.calculateProjections();
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.multi-select')) {
                        const dropdowns = document.querySelectorAll('.multi-select-dropdown');
                        dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
                    }
                });
            },

            handleFileUpload: function(file) {
                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                reader.onload = (e) => {
                    try {
                        let data;
                        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            data = this.parseExcel(e.target.result);
                        } else {
                            throw new Error('Please upload an Excel file (.xlsx or .xls)');
                        }

                        if (data && data.length > 0) {
                            this.originalData = data;
                            this.filteredData = [...data];
                            
                            // Create model data by filtering out excluded categories
                            this.modelData = data.filter(item => {
                                const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                return hasModelData && isNotExcluded;
                            }).map(item => ({
                                "Category": item.Category,
                                "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                            }));
                            
                            this.initializeDashboard();
                            this.updateMonthCountDisplay();
                            this.showUploadSuccess(file.name, data.length);
                        } else {
                            throw new Error('No valid data found in the file.');
                        }
                    } catch (error) {
                        console.error('File upload error:', error);
                        this.showUploadError(error.message);
                    }
                };

                reader.onerror = () => {
                    this.showUploadError('Error reading file. Please try again.');
                };

                reader.readAsArrayBuffer(file);
            },

            parseExcel: function(arrayBuffer) {
                console.log('parseExcel called');
                console.log('ArrayBuffer size:', arrayBuffer.byteLength);
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    console.log('Worksheet range:', worksheet['!ref']);
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: ''
                    });

                    console.log('Raw JSON data length:', jsonData.length);
                    console.log('First few rows of raw data:', jsonData.slice(0, 3));

                    if (jsonData.length < 2) {
                        throw new Error('Excel file must contain at least a header row and one data row.');
                    }

                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);

                    // Store raw headers for month counting
                    this.rawHeaders = headers;

                    // Normalize headers: trim, replace multiple spaces/dashes with a single space, and lowercase
                    const normalizedHeaders = headers.map(h => h ? h.toString().replace(/[\s\-]+/g, ' ').trim() : '');

                    const processedData = dataRows.filter(row => {
                        return row[0] && row[0].toString().trim() !== '';
                    }).map((row) => {
                        const obj = {};
                        normalizedHeaders.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        if (row === dataRows[0]) {
                            console.log('First parsed object (normalized headers):', obj);
                            Object.entries(obj).forEach(([k, v]) => {
                                console.log(`Key: '${k}' | Value: '${v}' | Char codes:`, k.split('').map(c => c.charCodeAt(0)));
                            });
                        }
                        const expenseGrowthAlignment = String(
                            obj['Expense Growth Alignment'] ||
                            ''
                        ).trim();
                        // Debug for Render environment - check first few rows
                        if (row === dataRows[0] || row === dataRows[1] || row === dataRows[2]) {
                            console.log(`=== RENDER DEBUG ROW ${dataRows.indexOf(row)} ===`);
                            console.log('Category:', obj['Category']);
                            console.log('Raw Expense Growth Alignment value:', obj['Expense Growth Alignment']);
                            console.log('Processed value:', expenseGrowthAlignment);
                            console.log('All keys in this row:', Object.keys(obj));
                            console.log('=== END DEBUG ===');
                        }
                        console.log(`Processing ${obj['Category']}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                        

                        
                        // Add this after the existing field mappings
                        let growthDeltaValue = '';
                        const possibleGrowthDeltaColumns = [
                            'Expense – GP Growth Δ [%] [Jul 2025]',
                            'Expense - GP Growth Δ [%] [Jul 2025]',
                            'Expense – GP Growth Î" [%] [Jul 2025]',
                            'Expense - GP Growth Delta [%] [Jul 2025]',
                            'Expense-GP Growth Delta [%] [Jul 2025]'
                        ];

                        for (const colName of possibleGrowthDeltaColumns) {
                            if (obj[colName] !== undefined && obj[colName] !== null && obj[colName] !== '') {
                                growthDeltaValue = String(obj[colName]).trim();
                                break;
                            }
                        }

                        return {
                            "Category": String(obj['Category'] || '').trim(),
                            "May": parseFloat(obj['May 2025']) || 0,
                            "June 2025": parseFloat(obj['June 2025']) || 0,
                            "July 2025": parseFloat(obj['Jul 2025'] || obj['July 2025'] || obj['July']) || 0,  // Add this line
                            "Anchor vs Prior Avg ($)": parseFloat(obj['Anchor vs Prior Avg ($)']) || 0,
                            "Performance Diagnostic Summary": String(obj['Margin Risk Assessment'] || '').trim(),
                            "Margin Leverage Classification": obj['Margin Risk Assessment'] === true ? 'High Risk' : 'Normal Risk',
                            "Ratio_Change_Anchor_vs_MeanPrior": parseFloat(obj['Ratio_Change_Anchor_vs_MeanPrior']) || 0,
                            "Fixed Cost Estimate": parseFloat(obj['Fixed Cost Estimate']) || 0,
                            "Marginal Cost per $1 GP": parseFloat(obj['Marginal Cost per $1 GP']) || 0,
                            "ROI Efficiency": parseFloat(obj['ROI Efficiency']) || 0,
                            "Efficiency Alert": String(obj['Efficiency Alert'] || '').trim(),
                            "Best Performing (Cost Decline Rank)": obj['Best Performing (Cost Decline Rank)'] || "",
                            "Expense Growth Alignment": expenseGrowthAlignment,
                            "Marketing Spend Efficiency": String(obj['Marketing Spend Efficiency'] || '').trim(),
                            "Elasticity Classification": String(obj['Elasticity Classification'] || '').trim(),
                            // Growth & Risk Driver columns
                            "# of Months Outpaced Growth": parseFloat(obj['# of Months Outpaced Growth']) || 0,
                            "# of Months Did Not Decline with Profit": parseFloat(obj['# of Months Did Not Decline with Profit']) || 0,
                            "# of Months Opposite Direction than Profit": parseFloat(obj['# of Months Opposite Direction than Profit']) || 0,
                            "Total Excess Costs (5% Buffer)": parseFloat(obj['Total Excess Costs (5% Buffer)']) || 0,
                            // Then in the return object, add:
                            "Expense – GP Growth Δ [%] [Jul 2025]": growthDeltaValue
                        };
                    });

                    return processedData;
                } catch (error) {
                    console.error('Excel parsing error:', error);
                    throw new Error(`Excel parsing failed: ${error.message}`);
                }
            },

            updateMonthCountDisplay: function() {
                if (!this.rawHeaders) return;
                
                // Count month columns (Jan 2025, Feb 2025, etc.)
                const monthColumns = this.rawHeaders.filter(header => {
                    const headerStr = String(header || '').trim();
                    return /^(Jan|Feb|Mar|Apr|May|June|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}$/i.test(headerStr);
                });
                
                const monthCount = monthColumns.length;
                const monthCountElement = document.getElementById('monthCountDisplay');
                if (monthCountElement) {
                    monthCountElement.textContent = `(${monthCount} months)`;
                }
                
                // Store the most recent month column for use in updateTable
                if (monthColumns.length > 0) {
                    this.mostRecentMonthColumn = monthColumns[monthColumns.length - 1];
                    console.log('Most recent month column set to:', this.mostRecentMonthColumn);
                }
                
                // Update most recent month display for Key Insights section
                const recentMonthElement = document.getElementById('recentMonthDisplay');
                if (recentMonthElement && monthColumns.length > 0) {
                    const lastMonth = monthColumns[monthColumns.length - 1];
                    const monthName = lastMonth.split(' ')[0]; // Extract just the month name
                    
                    // Convert month abbreviation to full name
                    const monthNames = {
                        'Jan': 'January', 'Feb': 'February', 'Mar': 'March', 'Apr': 'April',
                        'May': 'May', 'June': 'June', 'Jul': 'July', 'Aug': 'August',
                        'Sep': 'September', 'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
                    };
                    const fullMonthName = monthNames[monthName] || monthName;
                    recentMonthElement.textContent = `(${fullMonthName})`;
                }
                
                console.log(`Found ${monthCount} month columns:`, monthColumns);
                

            },

            loadSampleData: function() {
                this.originalData = [...this.sampleData];
                this.filteredData = [...this.sampleData];
                
                // Create model data by filtering out excluded categories
                this.modelData = this.originalData.filter(item => {
                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                    return hasModelData && isNotExcluded;
                }).map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                }));
                
                this.initializeDashboard();
                this.showUploadSuccess('Sample Data', this.sampleData.length);
            },

            loadPreloadedData: function() {
                console.log('loadPreloadedData called');
                
                // Add cache-busting timestamp to prevent caching
                const timestamp = new Date().getTime();
                
                // Try multiple sources for the Excel file with cache-busting
                const sources = [
                    `/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`,
                    `/public/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`
                ];
                
                const tryFetch = async (url) => {
                    try {
                        console.log('Trying to fetch from:', url);
                        
                        // Add cache-busting headers to prevent any caching
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        console.log('Response status:', response.status);
                        
                        if (response.ok) {
                            const arrayBuffer = await response.arrayBuffer();
                            console.log('Successfully fetched file, parsing...');
                            
                            const data = this.parseExcel(arrayBuffer);
                            if (data && data.length > 0) {
                                console.log('Main data columns:', Object.keys(data[0]));
                                console.log('Growth & Risk columns in main data:');
                                console.log('- # of Months Outpaced Growth:', data[0]['# of Months Outpaced Growth']);
                                console.log('- # of Months Did Not Decline with Profit:', data[0]['# of Months Did Not Decline with Profit']);
                                console.log('- # of Months Opposite Direction than Profit:', data[0]['# of Months Opposite Direction than Profit']);
                                console.log('- Total Excess Costs (5% Buffer):', data[0]['Total Excess Costs (5% Buffer)']);
                                console.log('=== END MAIN DATA DEBUG ===');
                                
                                this.originalData = data;
                                this.filteredData = [...data];
                                
                                // Create model data by filtering out excluded categories
                                this.modelData = data.filter(item => {
                                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                    return hasModelData && isNotExcluded;
                                }).map(item => ({
                                    "Category": item.Category,
                                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                                }));
                                
                                                // Chunk2 data loading removed - using main data only
                                
                                this.initializeDashboard();
                                this.showUploadSuccess('Pre-loaded Data (Fresh)', data.length);
                                return true;
                            }
                        }
                        return false;
                    } catch (error) {
                        console.error('Error fetching from', url, ':', error);
                        return false;
                    }
                };
                
                // Try each source until one works
                const attemptLoad = async () => {
                    for (const source of sources) {
                        const success = await tryFetch(source);
                        if (success) {
                            console.log('Successfully loaded fresh data from:', source);
                            return;
                        }
                    }
                    
                    // If all sources fail, show error
                    console.error('Failed to load data from all sources');
                    this.showUploadError('Failed to load pre-loaded data. Please check your connection and try again.');
                };
                
                attemptLoad();
            },



            initializeDashboard: function() {
                // Set the most recent month column for July 2025
                this.mostRecentMonthColumn = 'Jul 2025';
                
                const dashboardContent = document.getElementById('dashboardContent');
                if (dashboardContent) {
                    dashboardContent.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    this.setupFilters();
                    this.updateCharts();
                    // Don't call updateTable here - it will be called after data loads
                    this.updateGrowthRiskTable();
                    
                    setTimeout(() => {
                        this.updateInsights();
                        this.updateMonthCountDisplay();
                        // Now update the table after month column is set
                        this.updateTable();
                        this.calculateProjections();
                        this.isInitialized = true;
                    }, 200);
                }, 100);
            },

            setupFilters: function() {
                // Filter out excluded categories from dropdown options
                const categories = [...new Set(this.originalData
                    .filter(item => !this.isExcludedFromProjections(item.Category))
                    .map(item => item.Category))].sort();
                const marginClassifications = [...new Set(this.originalData.map(item => item['Margin Leverage Classification']))].sort();

                const categoryContainer = document.getElementById('categoryDropdown');
                if (categoryContainer) {
                    let categoryHTML = '';
                    categories.forEach(cat => {
                        const safeId = cat.replace(/[^a-zA-Z0-9]/g, '_');
                        categoryHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="cat_${safeId}" value="${cat}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('categoryDropdown', 'categoryButtonText')">
                                <label for="cat_${safeId}">${cat}</label>
                            </div>
                        `;
                    });
                    categoryContainer.innerHTML = categoryHTML;
                }

                const marginContainer = document.getElementById('marginDropdown');
                if (marginContainer) {
                    let marginHTML = '';
                    marginClassifications.forEach(margin => {
                        const safeId = margin.replace(/[^a-zA-Z0-9]/g, '_');
                        marginHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="margin_${safeId}" value="${margin}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('marginDropdown', 'marginButtonText')">
                                <label for="margin_${safeId}">${margin}</label>
                            </div>
                        `;
                    });
                    marginContainer.innerHTML = marginHTML;
                }

                this.updateDropdownText('categoryDropdown', 'categoryButtonText');
                this.updateDropdownText('marginDropdown', 'marginButtonText');
            },

            toggleDropdown: function(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.classList.toggle('show');
                }
            },

            updateDropdownText: function(dropdownId, buttonTextId) {
                const checkboxes = document.querySelectorAll(`#${dropdownId} input[type="checkbox"]:checked`);
                const buttonText = document.getElementById(buttonTextId);
                
                if (buttonText) {
                    if (checkboxes.length === 0) {
                        buttonText.innerHTML = 'None selected';
                    } else if (checkboxes.length === 1) {
                        buttonText.innerHTML = checkboxes[0].nextElementSibling.textContent;
                    } else {
                        buttonText.innerHTML = `${checkboxes.length} selected <span class="selected-count">${checkboxes.length}</span>`;
                    }
                }
            },

            applyFilters: function() {
                const selectedCategories = Array.from(document.querySelectorAll('#categoryDropdown input:checked')).map(cb => cb.value);
                const selectedMarginClassifications = Array.from(document.querySelectorAll('#marginDropdown input:checked')).map(cb => cb.value);

                this.filteredData = this.originalData.filter(item => 
                    selectedCategories.includes(item.Category) && 
                    selectedMarginClassifications.includes(item['Margin Leverage Classification']) &&
                    !this.isExcludedFromProjections(item.Category)
                );

                this.updateCharts();
                this.updateTable();
                this.updateGrowthRiskTable();
                this.updateMonthCountDisplay();
                
                if (this.isInitialized) {
                    this.updateInsights();
                }
            },

            updateCharts: function() {
                if (this.filteredData.length === 0) return;
                this.updatePerformanceChart();
            },

            updatePerformanceChart: function() {
                // Filter out revenue/income categories from the performance chart
                const chartData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                
                const performanceCounts = {};
                chartData.forEach(item => {
                    const perf = item['Performance Diagnostic Summary'] || 'Unknown';
                    performanceCounts[perf] = (performanceCounts[perf] || 0) + 1;
                });

                const ctx1 = document.getElementById('performanceChart');
                if (!ctx1) return;

                if (this.performanceChart) {
                    this.performanceChart.destroy();
                }

                this.performanceChart = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(performanceCounts),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(performanceCounts),
                            backgroundColor: ['#e53e3e', '#fd7900', '#48bb78', '#4299e1'],
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Math.round(value);
                                    }
                                } 
                            },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            },

            updateTable: function() {
                const table = document.getElementById('dataTable');
                if (!table) return;

                const tbody = table.querySelector('tbody');
                if (!tbody) return;

                // Filter out excluded categories from the table display
                const tableData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from table: "${item.Category}"`);
                    }
                    return !isExcluded &&
                        item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                        item.Category.toLowerCase().trim() !== 'gross profit' &&
                        !item.Category.toLowerCase().trim().includes('400000 management fees');
                });

                // Debug: print keys of first row
                if (tableData.length > 0) {
                    console.log('First row keys in filteredData:', Object.keys(tableData[0]));
                    console.log('First row in filteredData:', tableData[0]);
                }

                if (tableData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                    return;
                }

                const suggestedActionPriority = {
                    'Investigate - Potential Risk': 1,
                    'Efficient Scaling': 2,
                    'Productivity Gain': 3,
                    'Strong Cost Control': 4,
                    'Review Volatility': 5,
                    'No Comparison': 6,
                    'Stable - No Action': 7,
                    'Below Threshold': 8
                };

                const sortedData = [...tableData].sort((a, b) => {
                    const aAction = a['Efficiency Alert'] || 'N/A';
                    const bAction = b['Efficiency Alert'] || 'N/A';
                    const aPriority = suggestedActionPriority[aAction] || 999;
                    const bPriority = suggestedActionPriority[bAction] || 999;
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority;
                    }
                    
                    // Within the same action group, sort by category name
                    return (a.Category || '').localeCompare(b.Category || '');
                });

                let tableHTML = '';
                sortedData.forEach(item => {
                    tableHTML += '<tr>';
                    
                    // Category
                    tableHTML += `<td>${item.Category || 'N/A'}</td>`;
                    
                    // Expenses for Most Recent Month (dynamically from most recent month column)
                    const mostRecentExpenses = item['July 2025'] || item['June 2025'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(mostRecentExpenses).toLocaleString()}</td>`;
                    
                    // Most Recent Month vs. Avg. of Prior Months
                    const anchorPriorValue = item['Anchor vs Prior Avg ($)'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(anchorPriorValue).toLocaleString()}</td>`;
                    
                    // Expense Growth Alignment (as text)
                    const expenseGrowthAlignment = item['Expense Growth Alignment'] || '';
                    console.log(`Table row for ${item.Category}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                    console.log(`Full item for ${item.Category}:`, item);
                    tableHTML += `<td class="center-column">${expenseGrowthAlignment}</td>`;

                    // Suggested Action (using Efficiency Alert)
                    const suggestedAction = item['Efficiency Alert'] || 'N/A';
                    tableHTML += `<td class="center-column">${suggestedAction}</td>`;

                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateInsights: function() {
                // For most insights, filter out excluded categories
                const insightData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category) &&
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                );



                // Expenses Grew Faster Than GP (using Expense Growth Alignment)
                // Use less restrictive filtering for this specific metric
                console.log('=== EXPENSES GREW FASTER THAN GP DEBUG ===');
                console.log('Total filteredData items:', this.filteredData.length);
                
                const outpacedCategories = this.filteredData.filter(item => {
                    const cat = (item.Category || '').toLowerCase().trim();
                    
                    // Debug: Log specific categories we're looking for
                    if (cat.includes('612000') || cat.includes('430000') || cat.includes('medical services') || cat.includes('professional fees')) {
                        console.log(`DEBUG - Category: "${item.Category}", Expense Growth Alignment: "${item['Expense Growth Alignment']}"`);
                    }
                    
                    // Apply only essential exclusions for this metric (remove medical, services, fee, fees)
                    const essentialExclusions = [
                        'net operating income',
                        'total income',
                        'gross profit',
                        'net income',
                        'unapplied cash payment income',
                        'total expenses'
                    ];
                    
                    // Remove the problematic exclusions that are blocking our target categories
                    const essentialPatternExclusions = [
                        // Removed: '400000 management fees', '420000 services - doctors'
                    ];
                    
                    // Check essential exact matches
                    if (essentialExclusions.includes(cat)) {
                        console.log(`Excluding "${item.Category}" due to essential exclusion`);
                        return false;
                    }
                    
                    // Check essential pattern matches
                    for (let pattern of essentialPatternExclusions) {
                        if (cat.includes(pattern)) {
                            console.log(`Excluding "${item.Category}" due to pattern "${pattern}"`);
                            return false;
                        }
                    }
                    
                    // Check if starts with "total" (removed this exclusion)
                    // if (cat.startsWith('total ') && !cat.includes('medical') && !cat.includes('service')) {
                    //     console.log(`Excluding "${item.Category}" due to total exclusion`);
                    //     return false;
                    // }
                    
                    // Check for income/profit exclusions (keep medical/service categories)
                    if (cat.includes('income') || cat.includes('profit')) {
                        console.log(`Excluding "${item.Category}" due to income/profit exclusion`);
                        return false;
                    }
                    
                    // Now check if it has the right Expense Growth Alignment
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    const matches = growthAlignment === 'Expenses Grew Faster Than GP';
                    
                    if (cat.includes('612000') || cat.includes('430000') || cat.includes('medical services') || cat.includes('professional fees')) {
                        console.log(`Category "${item.Category}" - Growth Alignment: "${growthAlignment}", Matches: ${matches}`);
                    }
                    
                    return matches;
                });
                
                console.log('Found categories with Expenses Grew Faster Than GP:', outpacedCategories.map(item => item.Category));
                console.log('=== END EXPENSES GREW FASTER THAN GP DEBUG ===');
                
                const expenseOutpacedElement = document.getElementById('expenseOutpacedText');
                if (expenseOutpacedElement) {
                    if (outpacedCategories.length > 0) {
                        const categoryNames = outpacedCategories.map(item => item.Category);
                        expenseOutpacedElement.textContent = `(${outpacedCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseOutpacedElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Expenses Grew Even Though GP Declined (using Expense Growth Alignment)
                const grewDespiteDeclineCategories = insightData.filter(item => {
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    return growthAlignment === 'Expenses Grew Even Though GP Declined';
                });
                
                const expenseGrewDespiteDeclineElement = document.getElementById('expenseGrewDespiteDeclineText');
                if (expenseGrewDespiteDeclineElement) {
                    if (grewDespiteDeclineCategories.length > 0) {
                        const categoryNames = grewDespiteDeclineCategories.map(item => item.Category);
                        expenseGrewDespiteDeclineElement.textContent = `(${grewDespiteDeclineCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseGrewDespiteDeclineElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Top 3 highest variances (exclude income, gross profit, and related categories)
                // Select categories with value > $200 in Jul 2025 and highest absolute variances
                const topVariances = this.filteredData
                    .filter(item => {
                        const variance = item['Anchor vs Prior Avg ($)'];
                        const jul2025Value = item['July 2025'] || item['Jul 2025'] || 0;
                        const cat = (item.Category || '').toLowerCase().trim();
                        return variance !== undefined && variance !== null && variance !== 0 &&
                            Math.abs(jul2025Value) > 200 && // Must have value > $200 in Jul 2025
                            cat !== 'net ordinary income' && cat !== 'gross profit' && cat !== 'net ordinary expense' &&
                            !cat.includes('income') && !cat.includes('gross profit') && !cat.includes('profit') &&
                            !cat.includes('revenue') && !cat.includes('fee') && !cat.includes('fees');
                    })
                    .sort((a, b) => Math.abs(b['Anchor vs Prior Avg ($)']) - Math.abs(a['Anchor vs Prior Avg ($)']))
                    .slice(0, 3); // Take top 3
                
                const topVarianceElement = document.getElementById('topVarianceText');
                if (topVarianceElement) {
                    if (topVariances.length > 0) {
                        const formattedList = topVariances
                            .map((item, index) => {
                                const varianceAmount = Math.round(item['Anchor vs Prior Avg ($)']);
                                const sign = varianceAmount >= 0 ? '+' : '-';
                                const formattedVariance = `(${sign}${Math.abs(varianceAmount).toLocaleString()})`;
                                return `${index + 1}. ${item.Category} ${formattedVariance}`;
                            })
                            .join(', ');
                        topVarianceElement.textContent = formattedList;
                    } else {
                        topVarianceElement.textContent = 'No variance data available';
                    }
                }

                // Top 3 Performing Expense Categories - USE ORIGINAL DATA (include Total categories for performance ranking)
                const topPerformingCategories = this.filteredData
                    .filter(item => {
                        const rank = item['Best Performing (Cost Decline Rank)'];
                        return rank === 1 || rank === 2 || rank === 3 || rank === "1" || rank === "2" || rank === "3";
                    })
                    .sort((a, b) => {
                        const aRank = parseInt(a['Best Performing (Cost Decline Rank)']) || 999;
                        const bRank = parseInt(b['Best Performing (Cost Decline Rank)']) || 999;
                        return aRank - bRank;
                    });
                
                const topMarginElement = document.getElementById('topMarginText');
                if (topMarginElement) {
                    if (topPerformingCategories.length > 0) {
                        const formattedList = topPerformingCategories
                            .map((item) => `${parseInt(item['Best Performing (Cost Decline Rank)'])}. ${item.Category}`)
                            .join(', ');
                        topMarginElement.textContent = formattedList;
                    } else {
                        topMarginElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Marketing Spend Efficiency - Hardcoded values as requested
                const roiElement = document.getElementById('marketingROIText');
                if (roiElement) {
                    roiElement.textContent = 'Advertising & Marketing Fund (Inefficient, 0.06)';
                }


            },

            calculateProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                // Categories to exclude from Expense Projection Based on Gross Profit Forecast
                const excludedFromProjections = [
                    '400000 Management Fees',
                    '420000 Services - Doctors',
                    '430000 Medical Services (PC)',
                    'Total 600100 Payroll expenses',
                    'Total 610000 Supplies',
                    'Total 610600 Utilities',
                    'Total 611000 Computer Supplies & Software',
                    'Total 612000 Professional Fees',
                    'Total 613000 Insurance',
                    'Total 614000 Marketing & Advertising',
                    'Total 616000 Employee Benefits',
                    'Total 617000 Bank & Merchant Fees',
                    'Total 617300 Interest Expense',
                    'Total 631000 Franchise Costs',
                    'Total 650000 Depreciation Expense'
                ];
                
                // Calculate projections for all model data, excluding specified categories and Net Ordinary Income and Gross Profit
                const projections = this.modelData.filter(item =>
                    !excludedFromProjections.includes(item.Category) &&
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                ).map(item => {
                    const projectedExpense = item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP);
                    return {
                        ...item,
                        "Projected Expense": Math.round(Math.max(0, projectedExpense))
                    };
                });

                const totalProjectedExpenses = projections.reduce((sum, item) => sum + item["Projected Expense"], 0);
                const projectedProfit = estimatedGP - totalProjectedExpenses;

                const totalExpensesElement = document.getElementById('totalProjectedExpenses');
                const projectedProfitElement = document.getElementById('projectedProfit');
                
                if (totalExpensesElement) {
                    totalExpensesElement.textContent = `$${totalProjectedExpenses.toLocaleString()}`;
                }
                
                if (projectedProfitElement) {
                    projectedProfitElement.textContent = `$${projectedProfit.toLocaleString()}`;
                    projectedProfitElement.style.color = projectedProfit >= 0 ? '#48bb78' : '#f56565';
                }

                this.updateProjectionsTable(projections);
                this.updateTopDriversTable(projections);
            },

            updateProjectionsTable: function(projections) {
                const tbody = document.querySelector('#projectionTable tbody');
                if (!tbody) return;
                
                let tableHTML = '';
                projections.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${Math.round(item["Fixed Cost Estimate"]).toLocaleString()}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateTopDriversTable: function(projections) {
                const tbody = document.querySelector('#topDriversTable tbody');
                if (!tbody) return;
                
                const topDrivers = projections
                    .filter(item => item["Marginal Cost per $1 GP"] > 0)
                    .sort((a, b) => b["Marginal Cost per $1 GP"] - a["Marginal Cost per $1 GP"])
                    .slice(0, 5);
                
                let tableHTML = '';
                topDrivers.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateGrowthRiskTable: function() {
                const table = document.getElementById('growthRiskTable');
                if (!table) return;
                const tbody = table.querySelector('tbody');
                if (!tbody) return;
                
                // Use main data (expense-analysis.xlsx) for all metrics
                let mainData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from Growth & Risk Drivers: "${item.Category}"`);
                    }
                    return !isExcluded;
                }) || [];
                
                // Sort by Potential $ Loss Due to Excess Spending (highest to lowest)
                mainData.sort((a, b) => {
                    let aExcessCost = 0;
                    let bExcessCost = 0;
                    
                    // Try to find excess cost values for both items
                    const possibleExcessColumns = [
                        'Total Excess Costs (5% Buffer)',
                        'Excess Costs (5% Buffer)',
                        'Total Excess Costs',
                        'Excess Costs',
                        'Potential Loss',
                        'Excess Spending'
                    ];
                    
                    for (const colName of possibleExcessColumns) {
                        if (a[colName] !== undefined && a[colName] !== null && a[colName] !== '') {
                            aExcessCost = Number(a[colName]);
                            break;
                        }
                    }
                    
                    for (const colName of possibleExcessColumns) {
                        if (b[colName] !== undefined && b[colName] !== null && b[colName] !== '') {
                            bExcessCost = Number(b[colName]);
                            break;
                        }
                    }
                    
                    return bExcessCost - aExcessCost; // Highest to lowest
                });
                
                // Debug logging
                console.log('=== GROWTH RISK DEBUG ===');
                console.log('Main data available:', mainData.length > 0);
                if (mainData.length > 0) {
                    console.log('First main data item:', mainData[0]);
                    console.log('Main data columns:', Object.keys(mainData[0]));
                    
                    // Log all column names to help identify the correct ones
                    const allColumns = Object.keys(mainData[0]);
                    console.log('All available columns in main data:', allColumns);
                    
                    // Look for columns that might contain the data we need
                    const excessCostColumns = allColumns.filter(col => 
                        col.toLowerCase().includes('excess') || 
                        col.toLowerCase().includes('cost') || 
                        col.toLowerCase().includes('loss') ||
                        col.toLowerCase().includes('buffer')
                    );
                    console.log('Potential excess cost columns:', excessCostColumns);
                    
                    // Look for the specific columns we need for month counts
                    const monthCountColumns = allColumns.filter(col => 
                        col.toLowerCase().includes('months') || 
                        col.toLowerCase().includes('outpaced') ||
                        col.toLowerCase().includes('decline') ||
                        col.toLowerCase().includes('opposite')
                    );
                    console.log('Potential month count columns:', monthCountColumns);
                    
                    // Check for exact matches
                    console.log('Looking for exact column matches:');
                    console.log('  "# of Months Outpaced Growth":', allColumns.includes('# of Months Outpaced Growth'));
                    console.log('  "# of Months Did Not Decline with Profit":', allColumns.includes('# of Months Did Not Decline with Profit'));
                    console.log('  "# of Months Opposite Direction than Profit":', allColumns.includes('# of Months Opposite Direction than Profit'));
                }
                console.log('=== END GROWTH RISK DEBUG ===');
                
                let tableHTML = '';
                let hasData = false;
                
                mainData.forEach(item => {
                    // Use main data directly for all metrics
                    const dataSource = item;
                    
                    // Try to find the correct column names for excess costs
                    let excessCostValue = 0;
                    if (dataSource) {
                        // Try multiple possible column names for excess costs
                        const possibleExcessColumns = [
                            'Total Excess Costs (5% Buffer)',
                            'Excess Costs (5% Buffer)',
                            'Total Excess Costs',
                            'Excess Costs',
                            'Potential Loss',
                            'Excess Spending'
                        ];
                        
                        for (const colName of possibleExcessColumns) {
                            if (dataSource[colName] !== undefined && dataSource[colName] !== null && dataSource[colName] !== '') {
                                excessCostValue = Number(dataSource[colName]);
                                console.log(`Found excess cost value for ${item.Category} in column "${colName}":`, excessCostValue);
                                break;
                            }
                        }
                    }
                    
                    // Get month count values from main data
                    const outpacedGrowth = dataSource['# of Months Outpaced Growth'];
                    const didNotDecline = dataSource['# of Months Did Not Decline with Profit'];
                    const oppositeDirection = dataSource['# of Months Opposite Direction than Profit'];
                    

                    
                    // Check if we have any meaningful data
                    if (outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' && outpacedGrowth > 0) {
                        hasData = true;
                    }
                    if (didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' && didNotDecline > 0) {
                        hasData = true;
                    }
                    if (oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' && oppositeDirection > 0) {
                        hasData = true;
                    }
                    if (excessCostValue > 0) {
                        hasData = true;
                    }
                    
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item['Category'] || 'N/A'}</td>`;
                    tableHTML += `<td class="center-column">${outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' ? Number(outpacedGrowth).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' ? Number(didNotDecline).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' ? Number(oppositeDirection).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${excessCostValue > 0 ? '$' + Math.round(excessCostValue).toLocaleString() : '$0'}</td>`;
                    tableHTML += '</tr>';
                });
                
                // If no meaningful data found, show a message
                if (!hasData) {
                    tableHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #718096; font-style: italic;">Growth & Risk Drivers data not available. This section requires additional data that may not be present in the current file.</td></tr>';
                }
                
                tbody.innerHTML = tableHTML;
            },

            exportFilteredData: function() {
                const exportData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_filtered.csv');
            },

            exportAllData: function() {
                const exportData = this.originalData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_complete.csv');
            },

            exportProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                const projections = this.modelData.map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": Math.round(item["Fixed Cost Estimate"]),
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"],
                    "Projected Expense": Math.round(item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP)),
                    "Estimated Gross Profit": estimatedGP
                }));

                this.exportData(projections, `expense_projections_${estimatedGP.toLocaleString()}_gp.csv`);
            },

            exportData: function(dataToExport, fileName) {
                if (dataToExport.length === 0) {
                    alert('No data available to export');
                    return;
                }

                const headers = Object.keys(dataToExport[0]);
                const csvContent = [
                    headers.join(','),
                    ...dataToExport.map(row => 
                        headers.map(header => {
                            let value = row[header];
                            if (typeof value === 'number') {
                                value = Math.round(value);
                            }
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                value = `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Data exported successfully as ${fileName}`);
            },

            showUploadSuccess: function(fileName, recordCount) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status">
                            <h3>✅ Data Loaded Successfully!</h3>
                            <p><strong>File:</strong> ${fileName}</p>
                            <p><strong>Records loaded:</strong> ${recordCount}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer;">Upload Different File</button>
                        </div>
                    `;
                }
            },

            showUploadError: function(errorMessage) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status error">
                            <h3>❌ Upload Error</h3>
                            <p>${errorMessage}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                }
            },

            loadStatusSummaryData: async function() {
                console.log('🚀 loadStatusSummaryData function called!');
                const fileName = 'ZNC07 Status Summary Source File.xlsx';
                const sources = [
                    `/${fileName}`,
                    `/public/${fileName}`,
                    `/ZNC07%20Status%20Summary%20Source%20File.xlsx`,
                    `/public/ZNC07%20Status%20Summary%20Source%20File.xlsx`
                ];
                
                console.log('🔍 Loading Status Summary data from:', fileName);

                const tryFetch = async (url) => {
                    try {
                        console.log('🔍 Attempting to fetch:', url);
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        console.log('📡 Response status:', response.status, response.ok);
                        
                        if (!response.ok) {
                            console.log('❌ Response not OK');
                            return false;
                        }
                        
                        const arrayBuffer = await response.arrayBuffer();
                        console.log('📊 Array buffer size:', arrayBuffer.byteLength);
                        
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        console.log('📋 Workbook sheets:', workbook.SheetNames);
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        console.log('📄 Worksheet range:', worksheet['!ref']);
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: ''
                        });
                        
                        console.log('📈 Raw data length:', jsonData.length);
                        console.log('📈 First few rows:', jsonData.slice(0, 5));
                        
                        if (jsonData && jsonData.length > 0) {
                            // Process the data into a more usable format
                            this.statusSummaryData = this.processStatusSummaryData(jsonData);
                            console.log('✅ Status Summary data loaded and processed successfully');
                            console.log('📊 Processed data:', this.statusSummaryData);
                            
                            // Create the working charts with the processed data
                            this.createWorkingCharts();
                            return true;
                        } else {
                            console.log('❌ No JSON data extracted');
                        }
                    } catch (e) {
                        console.error('❌ Error in tryFetch:', e);
                        return false;
                    }
                    return false;
                };

                (async () => {
                    for (const src of sources) {
                        const ok = await tryFetch(src);
                        if (ok) {
                            console.log('✅ Successfully loaded from:', src);
                            return;
                        }
                    }
                    console.error('❌ Failed to load Status Summary data from all sources');
                    // No fallback data - charts will be empty
                    this.createWorkingCharts();
                })();
            },

            renderStatusSummary: function() {
                const statusSummaryDiv = document.getElementById('statusSummaryItems');
                if (!statusSummaryDiv) return;
                const data = this.statusSummaryData || [];
                if (!data.length) {
                    statusSummaryDiv.innerHTML = '<span>No summary data available.</span>';
                    return;
                }
                let html = '<ul style="padding-left:20px;line-height:1.7;">';
                data.forEach(row => {
                    Object.entries(row).forEach(([k, v]) => {
                        html += `<li><strong>${k}:</strong> ${v}</li>`;
                    });
                });
                html += '</ul>';
                statusSummaryDiv.innerHTML = html;
            },

            // Process the raw data into a structured format
            processStatusSummaryData: function(rawData) {
                console.log('🔄 Processing Status Summary data...');
                
                // Find the header row (usually contains month names)
                let headerRowIndex = -1;
                let monthColumns = [];
                
                for (let i = 0; i < Math.min(rawData.length, 10); i++) {
                    const row = rawData[i];
                    const potentialMonths = row.filter(cell => 
                        /^(Jan|Feb|Mar|Apr|May|Jun|July|Aug|Sep|Oct|Nov|Dec)$/i.test(String(cell).trim())
                    );
                    
                    if (potentialMonths.length >= 3) {
                        headerRowIndex = i;
                        monthColumns = row.map((cell, index) => ({
                            name: String(cell).trim(),
                            index: index
                        })).filter(col => /^(Jan|Feb|Mar|Apr|May|Jun|July)$/i.test(col.name));
                        console.log('📅 Found month columns:', monthColumns);
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    console.warn('⚠️ Could not find header row with months');
                    return [];
                }
                
                // Process the data rows
                const processedData = [];
                for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;
                    
                    const label = String(row[0] || '').trim();
                    if (!label) continue;
                    
                    const dataRow = {
                        label: label,
                        data: {}
                    };
                    
                    monthColumns.forEach(col => {
                        const value = row[col.index];
                        // Ensure proper number parsing, handling percentage values
                        let parsedValue = 0;
                        if (value) {
                            // If value is a string with %, remove it and parse
                            if (typeof value === 'string' && value.includes('%')) {
                                parsedValue = parseFloat(value.replace('%', ''));
                            } else {
                                parsedValue = parseFloat(value) || 0;
                            }
                        }
                        dataRow.data[col.name] = parsedValue;
                    });
                    
                    processedData.push(dataRow);
                }
                
                console.log('✅ Processed data rows:', processedData.length);
                return processedData;
            },





            // Create Status Summary charts with hardcoded data
            createWorkingCharts: function() {
                console.log('=== CREATING STATUS SUMMARY CHARTS ===');
                
                // Hardcoded data for charts using your provided values
                const revenueExpenseMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
                const defaultRevenue = [167402, 171035, 153822, 168961, 140398, 142988, 143332];
                const defaultExpenses = [182261, 146301, 154918, 147354, 181116, 145214, 138261];
                const marginMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Total'];
                const defaultMargin2025 = [-9, 14, -1, 13, -29, -2, 4, -1];
                const defaultMargin2024 = [-1, -1, -7, -12, -10, -9, -8, -7];
    
                console.log('Using hardcoded data for charts...');
                console.log('Chart data:', { 
                    revenueExpenseMonths: revenueExpenseMonths, 
                    marginMonths: marginMonths,
                    revenue: defaultRevenue, 
                    expenses: defaultExpenses, 
                    margin2025: defaultMargin2025, 
                    margin2024: defaultMargin2024 
                });
                
                // Create Revenue & Expenses Chart
                this.createRevenueExpenseChart(revenueExpenseMonths, defaultRevenue, defaultExpenses);
                
                // Create Margin Chart
                this.createMarginChart(marginMonths, defaultMargin2025, defaultMargin2024);
                
                console.log('=== STATUS SUMMARY CHARTS COMPLETED ===');
            },

            // Load financial performance data (hardcoded to avoid file loading issues)
            loadFinancialPerformanceData: function() {
                console.log('🚀 loadFinancialPerformanceData function called!');
                console.log('=== LOADING FINANCIAL PERFORMANCE DATA ===');
                
                // Hardcoded financial performance data from your updated Excel file
                this.financialPerformanceData = [
                    {
                        "Metric_ID": "TOTAL_EXPENSES",
                        "Metric_Name": "Total Expenses",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Team",
                        "Value_2024_Jan_July": 1235165.53,
                        "Value_2025_Jan_July": 1095429.51,
                        "Growth_Rate_Decimal": -0.11313141162545236,
                        "Growth_Rate_Percentage": -0.11313141162545236
                    },
                    {
                        "Metric_ID": "TOTAL_REVENUE",
                        "Metric_Name": "Total Revenue",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Team",
                        "Value_2024_Jan_July": 1157638.64,
                        "Value_2025_Jan_July": 1087941.57,
                        "Growth_Rate_Decimal": -0.060206240178714,
                        "Growth_Rate_Percentage": -0.060206240178714
                    },
                    {
                        "Metric_ID": "VISIT_COUNT",
                        "Metric_Name": "Visit Count",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "RCM/Marketing",
                        "Value_2024_Jan_July": 7171.0,
                        "Value_2025_Jan_July": 6741.0,
                        "Growth_Rate_Decimal": -0.05996374285315856,
                        "Growth_Rate_Percentage": -0.05996374285315856
                    },
                    {
                        "Metric_ID": "Owner Controlled",
                        "Metric_Name": "Owner Controlled",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Owner",
                        "Value_2024_Jan_July": 207103.0,
                        "Value_2025_Jan_July": 283651.48,
                        "Growth_Rate_Decimal": 0.36961550532826654,
                        "Growth_Rate_Percentage": 0.36961550532826654
                    },
                    {
                        "Metric_ID": "TAXES",
                        "Metric_Name": "Taxes",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Owner",
                        "Value_2024_Jan_July": 0.0,
                        "Value_2025_Jan_July": 43975.68,
                        "Growth_Rate_Decimal": 1.0,
                        "Growth_Rate_Percentage": 1.0
                    },
                    {
                        "Metric_ID": "VARIABLE_OPERATIONAL_COSTS",
                        "Metric_Name": "Variable Operational Costs",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Ops - Clinical Administrator Controlled",
                        "Value_2024_Jan_July": 721990.0,
                        "Value_2025_Jan_July": 558095.3200000001,
                        "Growth_Rate_Decimal": -0.2270040859291679,
                        "Growth_Rate_Percentage": -0.2270040859291679
                    },
                    {
                        "Metric_ID": "MARKETING_ADVERTISING",
                        "Metric_Name": "Marketing & Advertising",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Owner",
                        "Value_2024_Jan_July": 2692.0,
                        "Value_2025_Jan_July": 11173.95,
                        "Growth_Rate_Decimal": 3.150798662704309,
                        "Growth_Rate_Percentage": 3.150798662704309
                    },
                    {
                        "Metric_ID": "AFC Payments",
                        "Metric_Name": "AFC Payments",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Owner",
                        "Value_2024_Jan_July": 83695.0,
                        "Value_2025_Jan_July": 81222.2,
                        "Growth_Rate_Decimal": -0.029545373080829235,
                        "Growth_Rate_Percentage": -0.029545373080829235
                    },
                    {
                        "Metric_ID": "RMC Payments",
                        "Metric_Name": "RMC Payments",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Owner",
                        "Value_2024_Jan_July": 28185.0,
                        "Value_2025_Jan_July": 31743.66,
                        "Growth_Rate_Decimal": 0.12626077700904736,
                        "Growth_Rate_Percentage": 0.12626077700904736
                    },
                    {
                        "Metric_ID": "SUPPLY_PER_VISIT",
                        "Metric_Name": "Supply $ per Visit",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Ops - Clinical Administrator Controlled",
                        "Value_2024_Jan_July": 72790.88,
                        "Value_2025_Jan_July": 87455.3,
                        "Growth_Rate_Decimal": 0.20145957845268525,
                        "Growth_Rate_Percentage": 0.20145957845268525
                    },
                    {
                        "Metric_ID": "TOTAL_EXPENSE_PER_VISIT",
                        "Metric_Name": "Total Expense per visit",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Ops - Clinical Administrator Controlled",
                        "Value_2024_Jan_July": 172.24453074884954,
                        "Value_2025_Jan_July": 162.502523364486,
                        "Growth_Rate_Decimal": -0.056559168189603694,
                        "Growth_Rate_Percentage": -0.056559168189603694
                    },
                    {
                        "Metric_ID": "REVENUE_PER_VISIT",
                        "Metric_Name": "Revenue per Visit",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "RCM/Marketing",
                        "Value_2024_Jan_July": 161.43336215311672,
                        "Value_2025_Jan_July": 161.39171784601692,
                        "Growth_Rate_Decimal": -0.000257965928135118,
                        "Growth_Rate_Percentage": -0.000257965928135118
                    },
                    {
                        "Metric_ID": "PROFIT_PER_VISIT",
                        "Metric_Name": "Profit per Visit",
                        "Category": "YOY Expense & Profitability Analysis",
                        "Responsibility": "Team",
                        "Value_2024_Jan_July": -10.811168595732823,
                        "Value_2025_Jan_July": -1.1108055184690784,
                        "Growth_Rate_Decimal": -0.8972538899349406,
                        "Growth_Rate_Percentage": 0.8972538899349406
                    },
                    // Cashflow Projections - August
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_VISIT_AVG",
                        "Metric_Name": "August 2023/2024 Visit Average",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Historical",
                        "Value_2024_Jan_July": 1160.0,
                        "Value_2025_Jan_July": null,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_VISIT_PROJ",
                        "Metric_Name": "August 2025 Visit Projection",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 1090.442058290336,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_EXPENSES",
                        "Metric_Name": "August 2025 Expected Expenses",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 177199.58605494353,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_REVENUE",
                        "Metric_Name": "August 2025 Expected Revenue",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 175988.31699902384,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_PROFIT",
                        "Metric_Name": "August 2025 Expected Profit",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": -1211.2690559196926,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_AUGUST_CASH_POSITION",
                        "Metric_Name": "August 2025 End of Month Cash Position",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 16564.730944080307,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    // Cashflow Projections - September
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_VISIT_AVG",
                        "Metric_Name": "September 2023/2024 Visit Average",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Historical",
                        "Value_2024_Jan_July": 1050.0,
                        "Value_2025_Jan_July": null,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_VISIT_PROJ",
                        "Metric_Name": "September 2025 Visit Projection",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 987.0380700041835,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_EXPENSES",
                        "Metric_Name": "September 2025 Expected Expenses",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 160396.177032492,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_REVENUE",
                        "Metric_Name": "September 2025 Expected Revenue",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 159299.76969739227,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_PROFIT",
                        "Metric_Name": "September 2025 Expected Profit",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": -1096.4073330997997,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_SEPTEMBER_CASH_POSITION",
                        "Metric_Name": "September 2025 End of Month Cash Position",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 15468.323611992507,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    // Cashflow Projections - October
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_VISIT_AVG",
                        "Metric_Name": "October 2023/2024 Visit Average",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Historical",
                        "Value_2024_Jan_July": 1219.0,
                        "Value_2025_Jan_July": null,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_VISIT_PROJ",
                        "Metric_Name": "October 2025 Visit Projection",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 1145.9041974619997,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_EXPENSES",
                        "Metric_Name": "October 2025 Expected Expenses",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 186212.3236215312,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_REVENUE",
                        "Metric_Name": "October 2025 Expected Revenue",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 184939.4469153535,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_PROFIT",
                        "Metric_Name": "October 2025 Expected Profit",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": -1272.876706177689,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_OCTOBER_CASH_POSITION",
                        "Metric_Name": "October 2025 End of Month Cash Position",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 14195.446902802883,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    // Cashflow Projections - November
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_VISIT_AVG",
                        "Metric_Name": "November 2023/2024 Visit Average",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Historical",
                        "Value_2024_Jan_July": 1026.0,
                        "Value_2025_Jan_July": null,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_VISIT_PROJ",
                        "Metric_Name": "November 2025 Visit Projection",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 964.4771998326594,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_EXPENSES",
                        "Metric_Name": "November 2025 Expected Expenses",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 156729.97870032076,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_REVENUE",
                        "Metric_Name": "November 2025 Expected Revenue",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 155658.63210430904,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_PROFIT",
                        "Metric_Name": "November 2025 Expected Profit",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": -1071.3465960117173,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_NOVEMBER_CASH_POSITION",
                        "Metric_Name": "November 2025 End of Month Cash Position",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 13124.100306791166,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    // Cashflow Projections - December
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_VISIT_AVG",
                        "Metric_Name": "December 2023/2024 Visit Average",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Historical",
                        "Value_2024_Jan_July": 1030.0,
                        "Value_2025_Jan_July": null,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_VISIT_PROJ",
                        "Metric_Name": "December 2025 Visit Projection",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 968.2373448612467,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_EXPENSES",
                        "Metric_Name": "December 2025 Expected Expenses",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 157341.01175568262,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_REVENUE",
                        "Metric_Name": "December 2025 Expected Revenue",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 156265.4883698229,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_PROFIT",
                        "Metric_Name": "December 2025 Expected Profit",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": -1075.5233858597057,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    },
                    {
                        "Metric_ID": "CASHFLOW_DECEMBER_CASH_POSITION",
                        "Metric_Name": "December 2025 End of Month Cash Position",
                        "Category": "Remaining Year Cashflow Projections",
                        "Responsibility": "Forecast",
                        "Value_2024_Jan_July": null,
                        "Value_2025_Jan_July": 12048.57692093146,
                        "Growth_Rate_Decimal": null,
                        "Growth_Rate_Percentage": null
                    }
                ];
                
                console.log('✅ Financial Performance Data loaded (hardcoded):', this.financialPerformanceData);
                console.log('📊 YOY rows found:', this.financialPerformanceData.filter(row => row.Category === 'YOY Expense & Profitability Analysis').length);
                
                // Render the section immediately
                this.renderFinancialPerformanceSection();
            },



            // Render financial performance section
            renderFinancialPerformanceSection: function() {
                console.log('🎯 renderFinancialPerformanceSection called!');
                console.log('financialPerformanceData:', this.financialPerformanceData);
                console.log('financialPerformanceData.length:', this.financialPerformanceData ? this.financialPerformanceData.length : 'undefined');
                
                if (!this.financialPerformanceData || this.financialPerformanceData.length === 0) {
                    console.log('No financial performance data available - cannot render section');
                    return;
                }

                // Process the new data structure
                const expenseAnalysisData = [];
                const cashflowData = [];
                
                console.log('=== FINANCIAL PERFORMANCE DATA DEBUG ===');
                console.log('Total rows in financialPerformanceData:', this.financialPerformanceData.length);
                console.log('Sample rows:', this.financialPerformanceData.slice(0, 3));
                
                this.financialPerformanceData.forEach(row => {
                    console.log(`Processing row: Category="${row.Category}", Metric_Name="${row.Metric_Name}"`);
                    console.log('Full row data:', row);
                    
                    if (row.Category === 'YOY Expense & Profitability Analysis') {
                        // Handle NaN values properly
                        const val2024 = isNaN(row.Value_2024_Jan_July) ? 0 : parseFloat(row.Value_2024_Jan_July) || 0;
                        const val2025 = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                        let growth = isNaN(row.Growth_Rate_Decimal) ? 0 : parseFloat(row.Growth_Rate_Decimal) || 0;
                        
                        // Special handling for Profit per Visit: show 90% growth
                        if (row.Metric_Name === 'Profit per Visit') {
                            growth = 0.90; // 90% growth
                        }
                        
                        expenseAnalysisData.push({
                            title: row.Metric_Name,
                            responsibility: row.Responsibility,
                            val2024: val2024,
                            val2025: val2025,
                            growth: growth
                        });
                    } else if (row.Category === 'Remaining Year Cashflow Projections') {
                        console.log(`Found cashflow row: ${row.Metric_Name}`);
                        // Handle cashflow data - need to group by month
                        const month = this.extractMonthFromMetricName(row.Metric_Name);
                        console.log(`Extracted month: ${month} from "${row.Metric_Name}"`);
                        
                        if (month) {
                            let cashflowItem = cashflowData.find(item => item.month === month);
                            if (!cashflowItem) {
                                cashflowItem = { month: month, visitAvg: 0, visitProj: 0, expenses: 0, revenue: 0, profit: 0, cashPosition: 0 };
                                cashflowData.push(cashflowItem);
                                console.log(`Created new cashflow item for month: ${month}`);
                            }
                            
                            // Map the data based on metric name
                            if (row.Metric_Name.includes('Visit Average')) {
                                cashflowItem.visitAvg = isNaN(row.Value_2024_Jan_July) ? 0 : parseFloat(row.Value_2024_Jan_July) || 0;
                                console.log(`Set visitAvg for ${month}: ${cashflowItem.visitAvg}`);
                            } else if (row.Metric_Name.includes('Visit Projection')) {
                                cashflowItem.visitProj = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set visitProj for ${month}: ${cashflowItem.visitProj}`);
                            } else if (row.Metric_Name.includes('Expected Expenses')) {
                                cashflowItem.expenses = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set expenses for ${month}: ${cashflowItem.expenses}`);
                            } else if (row.Metric_Name.includes('Expected Revenue')) {
                                cashflowItem.revenue = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set revenue for ${month}: ${cashflowItem.revenue}`);
                            } else if (row.Metric_Name.includes('Expected Profit')) {
                                cashflowItem.profit = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set profit for ${month}: ${cashflowItem.profit}`);
                            } else if (row.Metric_Name.includes('Cash Position')) {
                                cashflowItem.cashPosition = isNaN(row.Value_2025_Jan_July) ? 0 : parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set cashPosition for ${month}: ${cashflowItem.cashPosition}`);
                            }
                        } else {
                            console.log(`Could not extract month from: "${row.Metric_Name}"`);
                        }
                    }
                });
                
                console.log('Final expenseAnalysisData:', expenseAnalysisData);
                console.log('Final cashflowData:', cashflowData);
                console.log('=== END FINANCIAL PERFORMANCE DATA DEBUG ===');

                // Sort cashflow data by month order
                const monthOrder = ['August', 'September', 'October', 'November', 'December'];
                cashflowData.sort((a, b) => monthOrder.indexOf(a.month) - monthOrder.indexOf(b.month));

                console.log('=== CALLING UPDATE KEY METRICS ===');
                console.log('expenseAnalysisData being passed:', expenseAnalysisData);
                console.log('Looking for Profit per Visit item:', expenseAnalysisData.find(item => item.title === 'Profit per Visit'));
                
                this.renderExpenseAnalysisTable(expenseAnalysisData);
                this.renderCashflowTable(cashflowData);
                this.updateKeyMetrics(expenseAnalysisData);
            },

            // Extract month from metric name
            extractMonthFromMetricName: function(metricName) {
                const months = ['August', 'September', 'October', 'November', 'December'];
                for (const month of months) {
                    if (metricName.includes(month)) {
                        return month;
                    }
                }
                return null;
            },

            // Format currency values
            formatCurrency: function(value) {
                if (Math.abs(value) >= 1000000) {
                    return `$${(value / 1000000).toFixed(1)}M`;
                } else if (Math.abs(value) >= 10000) {
                    return `$${Math.round(value / 1000)}K`;
                } else {
                    return `$${Math.round(value).toLocaleString()}`;
                }
            },

            // Format visit count values
            formatVisitCount: function(value) {
                return Math.round(value).toString();
            },

            // Format growth percentage
            formatGrowth: function(growth) {
                const percentage = (growth * 100).toFixed(0);
                const isPositive = growth >= 0;
                const arrow = isPositive ? '↗' : '↘';
                const color = isPositive ? '#38a169' : '#e53e3e';
                return `<div style="color: ${color}; display: flex; align-items: center; justify-content: center;"><span style="margin-right: 5px;">${arrow}</span>${percentage}%</div>`;
            },

            // Format absolute difference between 2025 and 2024 values
            formatAbsoluteDifference: function(val2025, val2024) {
                const difference = val2025 - val2024;
                const isPositive = difference >= 0;
                const color = isPositive ? '#38a169' : '#e53e3e';
                
                // Handle different data types (currency vs count)
                if (typeof val2025 === 'number' && typeof val2024 === 'number') {
                    if (Math.abs(difference) >= 1000000) {
                        return `<span style="color: ${color};">$${Math.round(difference / 1000000)}M</span>`;
                    } else if (Math.abs(difference) >= 1000) {
                        return `<span style="color: ${color};">$${Math.round(difference / 1000)}K</span>`;
                    } else {
                        return `<span style="color: ${color};">$${Math.round(difference)}</span>`;
                    }
                } else {
                    // For non-numeric values (like visit count), just show the difference
                    return `<span style="color: ${color};">${difference}</span>`;
                }
            },

            // Get responsibility color class
            getResponsibilityColor: function(responsibility) {
                const colors = {
                    "Team": "bg-blue-100 text-blue-800",
                    "Owner Controlled": "bg-purple-100 text-purple-800", 
                    "RCM/Marketing": "bg-green-100 text-green-800",
                    "Ops - Clinical Administrator Controlled": "bg-orange-100 text-orange-800",
                    "% of visits/revenue": "bg-gray-100 text-gray-800"
                };
                return colors[responsibility] || "bg-gray-100 text-gray-800";
            },

            // Get responsibility color style for inline styling
            getResponsibilityColorStyle: function(responsibility) {
                const colors = {
                    "Team": "background-color: #dbeafe; color: #1e40af;",
                    "Owner Controlled": "background-color: #f3e8ff; color: #7c3aed;", 
                    "RCM/Marketing": "background-color: #dcfce7; color: #166534;",
                    "Ops - Clinical Administrator Controlled": "background-color: #fed7aa; color: #c05621;",
                    "% of visits/revenue": "background-color: #f7fafc; color: #4a5568;"
                };
                return colors[responsibility] || "background-color: #f7fafc; color: #4a5568;";
            },

            // Render expense analysis table
            renderExpenseAnalysisTable: function(data) {
                const tbody = document.querySelector('#expenseAnalysisTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e2e8f0';
                    row.innerHTML = `
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem; color: #2d3748;">
                            <div style="font-weight: 600;">${item.title}</div>
                        </td>
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem;">
                            <span style="display: inline-flex; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; border-radius: 12px; ${this.getResponsibilityColorStyle(item.responsibility)}">
                                ${item.responsibility}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2024) : 
                                this.formatCurrency(item.val2024)
                            }
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2025) : 
                                this.formatCurrency(item.val2025)
                            }
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem;">
                            ${this.formatGrowth(item.growth)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatAbsoluteDifference(item.val2025, item.val2024)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Render cashflow table
            renderCashflowTable: function(data) {
                const tbody = document.querySelector('#cashflowTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e2e8f0';
                    
                    // Helper function to style negative values
                    const styleNegativeValue = (value, baseStyle) => {
                        if (value < 0) {
                            return baseStyle.replace('color: #2d3748', 'color: #e53e3e').replace('font-weight: 600', 'font-weight: 700').replace('font-weight: 700', 'font-weight: 700');
                        }
                        return baseStyle;
                    };
                    
                    row.innerHTML = `
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem; color: #2d3748;">
                            <div style="font-weight: 600;">${item.month}</div>
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatVisitCount(item.visitAvg)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatVisitCount(item.visitProj)}
                        </td>
                        <td style="${styleNegativeValue(item.expenses, 'padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;')}">
                            ${this.formatCurrency(item.expenses)}
                        </td>
                        <td style="${styleNegativeValue(item.revenue, 'padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;')}">
                            ${this.formatCurrency(item.revenue)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; ${item.profit < 0 ? 'color: #e53e3e; font-weight: 700;' : 'color: #38a169; font-weight: 700;'}">
                            ${this.formatCurrency(item.profit)}
                        </td>
                        <td style="${styleNegativeValue(item.cashPosition, 'padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748; font-weight: 700;')}">
                            ${this.formatCurrency(item.cashPosition)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Update key metrics display
            updateKeyMetrics: function(data) {
                console.log('=== UPDATE KEY METRICS DEBUG ===');
                console.log('Data received:', data);
                
                const revenueItem = data.find(item => item.title === 'Total Revenue');
                const expensesItem = data.find(item => item.title === 'Total Expenses');
                const visitItem = data.find(item => item.title === 'Visit Count');
                const profitItem = data.find(item => item.title === 'Profit per Visit');

                console.log('Found items:', { revenueItem, expensesItem, visitItem, profitItem });

                if (revenueItem) {
                    console.log('Updating revenue:', revenueItem);
                    document.getElementById('totalRevenue').textContent = this.formatCurrency(revenueItem.val2025);
                    // Update percentage change using specific ID - use same logic as table
                    const revenueGrowthElement = document.getElementById('totalRevenueGrowth');
                    if (revenueGrowthElement) {
                        const growthPercent = (revenueItem.growth * 100).toFixed(0);
                        console.log('Revenue growth percent:', growthPercent);
                        revenueGrowthElement.innerHTML = `<span style="margin-right: 5px;">${revenueItem.growth >= 0 ? '↗' : '↘'}</span>${growthPercent}%`;
                        revenueGrowthElement.style.color = revenueItem.growth >= 0 ? '#48bb78' : '#e53e3e';
                    }
                }
                if (expensesItem) {
                    console.log('Updating expenses:', expensesItem);
                    document.getElementById('totalExpenses').textContent = this.formatCurrency(expensesItem.val2025);
                    // Update percentage change using specific ID - use same logic as table
                    const expensesGrowthElement = document.getElementById('totalExpensesGrowth');
                    if (expensesGrowthElement) {
                        const growthPercent = (expensesItem.growth * 100).toFixed(0);
                        console.log('Expenses growth percent:', growthPercent);
                        expensesGrowthElement.innerHTML = `<span style="margin-right: 5px;">${expensesItem.growth >= 0 ? '↗' : '↘'}</span>${growthPercent}%`;
                        expensesGrowthElement.style.color = expensesItem.growth >= 0 ? '#48bb78' : '#e53e3e';
                    }
                }
                if (visitItem) {
                    console.log('Updating visit count:', visitItem);
                    document.getElementById('visitCount').textContent = this.formatVisitCount(visitItem.val2025);
                    // Update percentage change using specific ID - use same logic as table
                    const visitGrowthElement = document.getElementById('visitCountGrowth');
                    if (visitGrowthElement) {
                        const growthPercent = (visitItem.growth * 100).toFixed(0);
                        console.log('Visit growth percent:', growthPercent);
                        visitGrowthElement.innerHTML = `<span style="margin-right: 5px;">${visitItem.growth >= 0 ? '↗' : '↘'}</span>${growthPercent}%`;
                        visitGrowthElement.style.color = visitItem.growth >= 0 ? '#48bb78' : '#e53e3e';
                    }
                }
                if (profitItem) {
                    console.log('Updating profit per visit:', profitItem);
                    document.getElementById('profitPerVisit').textContent = this.formatCurrency(profitItem.val2025);
                    // Update percentage change using specific ID - use same logic as table
                    const profitGrowthElement = document.getElementById('profitPerVisitGrowth');
                    if (profitGrowthElement) {
                        const growthPercent = (profitItem.growth * 100).toFixed(0);
                        console.log('Profit growth percent (rounded):', growthPercent);
                        console.log('Setting innerHTML to:', `<span style="margin-right: 5px;">${profitItem.growth >= 0 ? '↗' : '↘'}</span>${growthPercent}%`);
                        profitGrowthElement.innerHTML = `<span style="margin-right: 5px;">${profitItem.growth >= 0 ? '↗' : '↘'}</span>${growthPercent}%`;
                        profitGrowthElement.style.color = profitItem.growth >= 0 ? '#48bb78' : '#e53e3e';
                        console.log('Updated profit growth element');
                    } else {
                        console.error('Profit growth element NOT FOUND!');
                        console.log('profitPerVisit element:', document.getElementById('profitPerVisit'));
                        console.log('profitPerVisit parent:', document.getElementById('profitPerVisit')?.parentElement);
                        console.log('profitPerVisit next sibling:', document.getElementById('profitPerVisit')?.parentElement?.nextElementSibling);
                    }
                }
                
                console.log('=== END UPDATE KEY METRICS DEBUG ===');
            },

            // Helper function to create Revenue & Expenses Chart
            createRevenueExpenseChart: function(months, revenueData, expensesData) {
                const revenueCtx = document.getElementById('workingRevenueChart');
                if (revenueCtx && typeof Chart !== 'undefined') {
                    try {
                        // Destroy existing chart if any
                        if (window.workingRevenueChart && typeof window.workingRevenueChart.destroy === 'function') {
                            window.workingRevenueChart.destroy();
                        }
                        
                        window.workingRevenueChart = new Chart(revenueCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: '2025 Revenue (Gross Profit)',
                                        data: revenueData,
                                        backgroundColor: '#667eea'
                                    },
                                    {
                                        label: '2025 Total Expenses',
                                        data: expensesData,
                                        backgroundColor: '#48bb78'
                                    }
                                ]
                            },
                            options: {
                                responsive: false,
                                maintainAspectRatio: false,
                                plugins: { 
                                    legend: { display: true },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = Math.round(context.parsed.y);
                                                return context.dataset.label + ': $' + value.toLocaleString();
                                            }
                                        }
                                    }
                                },
                                scales: { 
                                    y: { 
                                        beginAtZero: true,
                                        title: { display: true, text: 'Amount ($)' }
                                    } 
                                }
                            }
                        });
                        console.log('✅ Revenue & Expenses Chart created successfully!');
                    } catch (error) {
                        console.error('❌ Revenue chart creation failed:', error);
                    }
                }
            },

            // Helper function to create Margin Chart
            createMarginChart: function(months, margin2025Data, margin2024Data) {
                const marginCtx = document.getElementById('workingMarginChart');
                if (marginCtx && typeof Chart !== 'undefined') {
                    try {
                        // Destroy existing chart if any
                        if (window.workingMarginChart && typeof window.workingMarginChart.destroy === 'function') {
                            window.workingMarginChart.destroy();
                        }
                        
                        window.workingMarginChart = new Chart(marginCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: '2025 Margin %',
                                        data: margin2025Data,
                                        backgroundColor: '#8ec6fd'
                                    },
                                    {
                                        label: '2024 Margin %',
                                        data: margin2024Data,
                                        backgroundColor: '#fdc88e'
                                    }
                                ]
                            },
                            options: {
                                responsive: false,
                                maintainAspectRatio: false,
                                plugins: { 
                                    legend: { display: true },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                return context.dataset.label + ': ' + Math.round(value) + '%';
                                            }
                                        }
                                    }
                                },
                                scales: { 
                                    y: { 
                                        beginAtZero: true,
                                        max: 30,
                                        title: { display: true, text: 'Margin (%)' },
                                        ticks: {
                                            callback: function(value) {
                                                return Math.round(value) + '%';
                                            }
                                        }
                                    } 
                                }
                            }
                        });
                        console.log('✅ Margin Chart created successfully!');
                    } catch (error) {
                        console.error('❌ Margin chart creation failed:', error);
                    }
                }
            },
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded at:', new Date().toISOString());
            window.dashboard.init();
            // Automatically load pre-loaded data
            window.dashboard.loadPreloadedData();
            console.log('About to call loadStatusSummaryData...');
            window.dashboard.loadStatusSummaryData();
            window.dashboard.loadFinancialPerformanceData();
        });
    </script>
</body>
</html>
