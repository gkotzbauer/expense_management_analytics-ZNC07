<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMT Margin Performance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .upload-container h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .upload-container p {
            color: #718096;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-content p {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .upload-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #a0aec0 !important;
        }

        .sample-data-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .sample-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.2s ease;
        }

        .sample-btn:hover {
            transform: translateY(-2px);
        }

        .data-status {
            background: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #2f855a;
        }

        .data-status.error {
            background: #fed7d7;
            border-color: #fc8181;
            color: #c53030;
        }

        .filters-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .filter-group h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .multi-select {
            position: relative;
            min-height: 40px;
        }

        .multi-select-button {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .multi-select-button:hover {
            border-color: #667eea;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 999999;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f7fafc;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .insights-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .insight-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .export-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }

        .center-column {
            text-align: center !important;
        }

        .projection-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .projection-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .projection-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .projection-header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .projection-input-section {
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .input-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä RMT Margin Performance Dashboard</h1>
            <p>Comprehensive margin insights to drive performance optimization and profitability management</p>
            <button onclick="window.dashboard.loadPreloadedData()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                üîÑ Refresh Data
            </button>
        </div>

        <!-- Financial Performance Overview Section -->
        <div class="insights-section">
            <h2>üìä Financial Performance Overview</h2>
            <p style="color: #718096; margin-bottom: 20px;">Performance analysis for Jan-July 2024 vs 2025</p>
            
            <!-- Key Metrics Summary -->
            <div style="margin-bottom: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Total Revenue</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="totalRevenue">$933K</p>
                                <div style="color: #38a169; font-size: 0.9rem; margin-top: 5px;">
                                    <span style="margin-right: 5px;">‚Üó</span>35.4%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #667eea;">üí∞</div>
                        </div>
                    </div>
                    
                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #48bb78;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Total Expenses</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="totalExpenses">$788K</p>
                                <div style="color: #e53e3e; font-size: 0.9rem; margin-top: 5px;">
                                    <span style="margin-right: 5px;">‚Üò</span>12.1%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #48bb78;">üìä</div>
                        </div>
                    </div>

                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #805ad5;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Visit Count</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="visitCount">8,156</p>
                                <div style="color: #38a169; font-size: 0.9rem; margin-top: 5px;">
                                    <span style="margin-right: 5px;">‚Üó</span>25.7%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #805ad5;">üë•</div>
                        </div>
                    </div>

                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px; border-left: 4px solid #ed8936;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 5px;">Profit per Visit</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="profitPerVisit">$18</p>
                                <div style="color: #e53e3e; font-size: 0.9rem; margin-top: 5px;">
                                    <span style="margin-right: 5px;">‚Üò</span>155.6%
                                </div>
                            </div>
                            <div style="font-size: 2rem; color: #ed8936;">üí∞</div>
                        </div>
                    </div>
                </div>

                <!-- YOY Expense & Profitability Analysis -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600;">YOY Expense & Profitability Analysis</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;" id="expenseAnalysisTable">
                            <thead style="background: #f7fafc;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Metric</th>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Responsibility</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2024 Jan-July</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2025 Jan-July</th>
                                    <th style="padding: 12px; text-align: center; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Growth</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Remaining Year Cashflow Projections -->
                <div>
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600;">
                        <span style="margin-right: 10px;">üìÖ</span>
                        Remaining Year Cashflow Projections
                    </h3>
                    <p style="color: #718096; margin-bottom: 20px; font-size: 0.9rem;">5-month projection based on current trends</p>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;" id="cashflowTable">
                            <thead style="background: #f7fafc;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Month</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2023/24 Visit Avg</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">2025 Visit Projection</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Expenses</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Revenue</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Expected Profit</th>
                                    <th style="padding: 12px; text-align: right; font-size: 0.8rem; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.05em;">Cash Position</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Insights Section -->
        <div id="dashboardContent" class="hidden">


            <div class="insights-section" id="statusSummarySection">
                <h2>üéØ Status Summary</h2>
                <div id="statusSummaryItems" style="margin-bottom: 20px;"></div>
                <div style="display: flex; align-items: flex-start; gap: 32px;">
                    <div style="min-width: 650px; max-width: 800px; width: 100%;">
                        <canvas id="statusSummaryChart" width="650" height="520"></canvas>
                    </div>
                    <div style="min-width: 650px; max-width: 800px; width: 100%;">
                        <canvas id="marginSummaryChart" width="650" height="520"></canvas>
                    </div>
                </div>
            </div>

            <div class="insights-section">
                <h2>ÔøΩÔøΩ Key Insights</h2>
                <div class="insight-item" id="expenseOutpacedInsight">
                    <span style="font-size: 1.2rem;">‚ö†Ô∏è </span>
                    <strong>Expenses Grew Faster Than GP:</strong> <span id="expenseOutpacedText">Loading...</span>
                </div>
                <div class="insight-item" id="expenseGrewDespiteDeclineInsight">
                    <span style="font-size: 1.2rem;">‚ö†Ô∏è </span>
                    <strong>Expenses Grew Even Though GP Declined:</strong> <span id="expenseGrewDespiteDeclineText">Loading...</span>
                </div>
                <div class="insight-item" id="topVarianceInsight">
                    <span style="font-size: 1.2rem;">üìà </span>
                    <strong>Expense in Most Recent Month with Highest Variance:</strong> <span id="topVarianceText">Loading...</span>
                </div>
                <div class="insight-item" id="marginInsight">
                    <span style="font-size: 1.2rem;">üèÜ </span>
                    <strong>Top Performing Expense Categories with Controlled Cost (relative to change in revenue):</strong> <span id="topMarginText">Loading...</span>
                </div>
                <div class="insight-item" id="marketingROIInsight">
                    <span style="font-size: 1.2rem;">üí∞ </span>
                    <strong>Marketing Spend Efficiency:</strong> <span id="marketingROIText">Loading...</span>
                </div>

                
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Marketing Spend Efficiency</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Unclassified:</strong> Average marketing spend below $500 or missing data‚Äîunable to assess efficiency.</li>
                        <li><strong>Under-Leveraged:</strong> Marketing spend grew less than 80% of profit growth‚Äîlikely room to increase investment.</li>
                        <li><strong>Efficient:</strong> Marketing spend growth tracked profit growth within ¬±20% (80‚Äì120%)‚Äîgood ROI.</li>
                        <li><strong>Inefficient:</strong> Marketing spend grew more than 120% of profit growth‚Äîspend outpacing returns, needs review.</li>
                    </ul>
                </div>
            </div>

            <div class="chart-container">
                <h2>üìä Margin Risk Assessment</h2>
                <canvas id="performanceChart" width="400" height="300"></canvas>
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Margin Risk Assessment Definitions</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Margin Improvement:</strong> Expense reductions or better expense control relative to profit‚Äîexpenses are declining, or increasing more slowly than profit, driving improved margins.</li>
                        <li><strong>Margin Risk:</strong> Expenses are rising faster than profit, or are increasing while profit is flat or declining. This expense appears to be threat to margins that warrants immediate investigation and action.</li>
                        <li><strong>Below Threshold:</strong> An expense category will be assigned "Below Threshold" if its average monthly expense is below $500 or if it's a one-time expense.</li>
                        <li><strong>Neutral:</strong> Expenses and profit are changing at similar rates, or neither cost nor profit are moving in a way that indicates significant risk or improvement. No immediate concern - keep under review.</li>
                    </ul>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>üìã Most Recent Month Key Insights <span id="recentMonthDisplay"></span></h2>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="window.dashboard.exportAllData()">üìà Export All Data</button>
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 15px; font-style: italic;">
                    <strong>Table Organization:</strong> Categories are ranked by Suggested Action, with Investigate - Potential Risk ranked first.
                </p>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 250px;">Category</th>
                            <th class="center-column" style="width: 200px;">Expenses for Most Recent Month</th>
                            <th class="center-column" style="width: 200px;">Most Recent Month vs. Avg. of Prior Months</th>
                            <th class="center-column">Expense Growth Alignment</th>
                            <th class="center-column">Suggested Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>üìã Expense Trends Over Entire Dataset <span id="monthCountDisplay"></span></h2>
                </div>
                <table id="growthRiskTable">
                    <thead>
                        <tr>
                            <th style="width: 180px;">Category</th>
                            <th class="center-column" style="width: 180px;"># of Months Outpaced Growth</th>
                            <th class="center-column" style="width: 220px;"># of Months Did Not Decline with Profit</th>
                            <th class="center-column" style="width: 220px;"># of Months Opposite Direction than Profit</th>
                            <th class="center-column" style="width: 220px;">Potential $ Loss Due to Excess Spending</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 24px; font-size: 0.9rem; color: #718096;">
                    <span style="font-weight: bold; color: #2d3748; font-size: 0.95rem;">Potential $ Loss Due to Excess Spending:</span>
                    <span style="color: #718096; font-size: 0.9rem;"> Excess cost is the amount by which an expense category's growth exceeds the growth in gross profit by more than 5%. For example, if gross profit rises by 5%, any portion of expense growth above 10% (5% profit increase + 5% buffer) is flagged as excess cost. If gross profit declines, expenses are expected to decline at least as much (plus 5%); any shortfall is counted as excess.</span>
                </div>
            </div>

            <div class="projection-container">
                <div class="projection-header">
                    <h2> Expense Projection Based on Gross Profit Forecast</h2>
                    <p>Enter an estimated gross profit to see projected expenses for each category</p>
                    <p style="font-size: 0.9rem; color: #718096; margin-top: 10px;">
                        <strong>Formula:</strong> Projected Expense = Fixed Cost Estimate + (Marginal Cost per $1 GP √ó Estimated Gross Profit)
                    </p>
                </div>
                
                <div class="projection-input-section">
                    <div class="input-group">
                        <label for="estimatedGP">Estimated Gross Profit for the Month ($)</label>
                        <input type="number" id="estimatedGP" value="147081" min="0" step="1000">
                    </div>
                    <button class="sample-btn" onclick="window.dashboard.calculateProjections()">Calculate Projections</button>
                </div>

                <div class="projection-summary">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="totalProjectedExpenses" style="color: #f56565; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Total Projected Expenses</p>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="projectedProfit" style="color: #48bb78; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Projected Profit</p>
                        </div>
                    </div>
                </div>

                <div class="projection-results">
                    <div class="table-header">
                        <h3>üìä Projected Expenses by Category</h3>
                        <div class="export-buttons">
                            <button class="export-btn secondary" onclick="window.dashboard.exportProjections()">üìà Export Projections</button>
                        </div>
                    </div>
                    <table id="projectionTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Fixed Cost Estimate</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="top-drivers">
                    <h3>üöÄ Top Expense Categories Growing Fastest with Revenue</h3>
                    <table id="topDriversTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.dashboard = {
            originalData: [],
            filteredData: [],
            modelData: [],
            performanceChart: null,
            isInitialized: false,

            sampleData: [
                {
                    "Category": "Other",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R¬≤ Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk ‚Äì Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 1
                },
                {
                    "Category": "Total Taxes",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R¬≤ Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk ‚Äì Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 2
                },
                {
                    "Category": "Net Other Income/Expense",
                    "January": -3328.87,
                    "February": -4545.14,
                    "March": -3460.13,
                    "April": -10716.94,
                    "May": -4673.57,
                    "Nonzero Month Count": 5,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": -5344.93,
                    "R¬≤ Linear": 0.0181,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1215.905209574297,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": -5344.93,
                    "Reconciled Anchor Month Expense": -3237.716674753547,
                    "Estimated Future Expense": -5344.93,
                    "Mean Prior Months Expense": -5512.77,
                    "Mean All Months Expense": -5344.93,
                    "Anchor vs Prior Avg ($)": 839.2000000000007,
                    "Ratio_Change_Anchor_vs_MeanPrior": -0.1522283715808932,
                    "Expense vs Profit Growth Ratio": 0.06020386891180868,
                    "Expense Growth Alignment": "Costs Grew Slower than Profit",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 3
                },
                {
                    "Category": "Supplies/Giveaways",
                    "January": 1606.2,
                    "February": 0.0,
                    "March": 0.0,
                    "April": 0.0,
                    "May": 862.56,
                    "Nonzero Month Count": 2,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 493.7520000000001,
                    "R¬≤ Linear": 0.0,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 0.0,
                    "Model Status": "Insufficient-data",
                    "Estimated Anchor Month Expense": 493.7520000000001,
                    "Reconciled Anchor Month Expense": 299.0926136718186,
                    "Estimated Future Expense": 493.7520000000001,
                    "Mean Prior Months Expense": 401.55,
                    "Mean All Months Expense": 493.7520000000001,
                    "Anchor vs Prior Avg ($)": 461.0099999999999,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.148076204706761,
                    "Expense vs Profit Growth Ratio": -0.4540456460982601,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 4
                },
                {
                    "Category": "Physicians",
                    "January": 481.86,
                    "February": 0.0,
                    "March": 196.4,
                    "April": 193.22,
                    "May": 538.44,
                    "Nonzero Month Count": 4,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 281.984,
                    "R¬≤ Linear": 0.8292,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": -12.74300624680268,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 281.984,
                    "Reconciled Anchor Month Expense": 170.8131441971559,
                    "Estimated Future Expense": 281.984,
                    "Mean Prior Months Expense": 217.87,
                    "Mean All Months Expense": 281.984,
                    "Anchor vs Prior Avg ($)": 320.5700000000001,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.471382016799009,
                    "Expense vs Profit Growth Ratio": -0.5819078870687899,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 5
                },
                {
                    "Category": "Medical Waste Removal",
                    "January": 0.0,
                    "February": 0.0,
                    "March": 130.02,
                    "April": 130.02,
                    "May": 263.94,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 104.796,
                    "R¬≤ Linear": 0.462,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 60.2350312182221,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 104.796,
                    "Reconciled Anchor Month Expense": 63.48067358178174,
                    "Estimated Future Expense": 104.796,
                    "Mean Prior Months Expense": 65.01,
                    "Mean All Months Expense": 104.796,
                    "Anchor vs Prior Avg ($)": 198.93,
                    "Ratio_Change_Anchor_vs_MeanPrior": 3.059990770650669,
                    "Expense vs Profit Growth Ratio": -1.210177060389181,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 6
                }
            ],

            // Function to check if a category should be excluded from projections
            isExcludedFromProjections: function(categoryName) {
                const category = categoryName.toLowerCase().trim();
                
                // Exact exclusions (removed 'total expenses')
                const exactExclusions = [
                    'net operating income',
                    'total income',
                    'gross profit',
                    'net income',
                    'unapplied cash payment income'
                ];
                
                // Pattern exclusions (removed all)
                const patternExclusions = [];
                
                // New exclusion patterns (removed fee, fees, services-doctors, medical services)
                const newExclusions = [
                    'income',
                    'profit'
                ];
                
                // Check exact matches
                if (exactExclusions.includes(category)) {
                    return true;
                }
                
                // Check pattern matches (removed all pattern exclusions)
                for (let pattern of patternExclusions) {
                    if (category.includes(pattern)) {
                        return true;
                    }
                }
                
                // Check new exclusion patterns
                for (let pattern of newExclusions) {
                    if (category.includes(pattern)) {
                        console.log(`Excluding category "${categoryName}" due to pattern "${pattern}"`);
                        return true;
                    }
                }
                
                // Check if starts with "total" (removed this exclusion)
                // if (category.startsWith('total ')) {
                //     return true;
                // }
                
                return false;
            },

            init: function() {
                this.setupFileUpload();
                this.setupEventListeners();
            },

            setupFileUpload: function() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const useSampleDataBtn = document.getElementById('useSampleData');

                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.handleFileUpload(e.target.files[0]);
                        }
                    });

                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files.length > 0) {
                            this.handleFileUpload(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (useSampleDataBtn) {
                    useSampleDataBtn.addEventListener('click', () => {
                        this.loadSampleData();
                    });
                }
            },

            setupEventListeners: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                if (estimatedGPInput) {
                    estimatedGPInput.addEventListener('change', () => {
                        this.calculateProjections();
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.multi-select')) {
                        const dropdowns = document.querySelectorAll('.multi-select-dropdown');
                        dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
                    }
                });
            },

            handleFileUpload: function(file) {
                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                reader.onload = (e) => {
                    try {
                        let data;
                        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            data = this.parseExcel(e.target.result);
                        } else {
                            throw new Error('Please upload an Excel file (.xlsx or .xls)');
                        }

                        if (data && data.length > 0) {
                            this.originalData = data;
                            this.filteredData = [...data];
                            
                            // Create model data by filtering out excluded categories
                            this.modelData = data.filter(item => {
                                const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                return hasModelData && isNotExcluded;
                            }).map(item => ({
                                "Category": item.Category,
                                "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                            }));
                            
                            this.initializeDashboard();
                            this.updateMonthCountDisplay();
                            this.showUploadSuccess(file.name, data.length);
                        } else {
                            throw new Error('No valid data found in the file.');
                        }
                    } catch (error) {
                        console.error('File upload error:', error);
                        this.showUploadError(error.message);
                    }
                };

                reader.onerror = () => {
                    this.showUploadError('Error reading file. Please try again.');
                };

                reader.readAsArrayBuffer(file);
            },

            parseExcel: function(arrayBuffer) {
                console.log('parseExcel called');
                console.log('ArrayBuffer size:', arrayBuffer.byteLength);
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    console.log('Worksheet range:', worksheet['!ref']);
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: ''
                    });

                    console.log('Raw JSON data length:', jsonData.length);
                    console.log('First few rows of raw data:', jsonData.slice(0, 3));

                    if (jsonData.length < 2) {
                        throw new Error('Excel file must contain at least a header row and one data row.');
                    }

                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);

                    // Store raw headers for month counting
                    this.rawHeaders = headers;

                    // Normalize headers: trim, replace multiple spaces/dashes with a single space, and lowercase
                    const normalizedHeaders = headers.map(h => h ? h.toString().replace(/[\s\-]+/g, ' ').trim() : '');

                    const processedData = dataRows.filter(row => {
                        return row[0] && row[0].toString().trim() !== '';
                    }).map((row) => {
                        const obj = {};
                        normalizedHeaders.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        if (row === dataRows[0]) {
                            console.log('First parsed object (normalized headers):', obj);
                            Object.entries(obj).forEach(([k, v]) => {
                                console.log(`Key: '${k}' | Value: '${v}' | Char codes:`, k.split('').map(c => c.charCodeAt(0)));
                            });
                        }
                        const expenseGrowthAlignment = String(
                            obj['Expense Growth Alignment'] ||
                            ''
                        ).trim();
                        // Debug for Render environment - check first few rows
                        if (row === dataRows[0] || row === dataRows[1] || row === dataRows[2]) {
                            console.log(`=== RENDER DEBUG ROW ${dataRows.indexOf(row)} ===`);
                            console.log('Category:', obj['Category']);
                            console.log('Raw Expense Growth Alignment value:', obj['Expense Growth Alignment']);
                            console.log('Processed value:', expenseGrowthAlignment);
                            console.log('All keys in this row:', Object.keys(obj));
                            console.log('=== END DEBUG ===');
                        }
                        console.log(`Processing ${obj['Category']}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                        

                        
                        return {
                            "Category": String(obj['Category'] || '').trim(),
                            "May": parseFloat(obj['May 2025']) || 0,
                            "Jun 2025": parseFloat(obj['Jun 2025']) || 0,
                            "Anchor vs Prior Avg ($)": parseFloat(obj['Anchor vs Prior Avg ($)']) || 0,
                            "Performance Diagnostic Summary": String(obj['Margin Risk Assessment'] || '').trim(),
                            "Margin Leverage Classification": obj['Margin Risk Assessment'] === true ? 'High Risk' : 'Normal Risk',
                            "Ratio_Change_Anchor_vs_MeanPrior": parseFloat(obj['Ratio_Change_Anchor_vs_MeanPrior']) || 0,
                            "Fixed Cost Estimate": parseFloat(obj['Fixed Cost Estimate']) || 0,
                            "Marginal Cost per $1 GP": parseFloat(obj['Marginal Cost per $1 GP']) || 0,
                            "ROI Efficiency": parseFloat(obj['ROI Efficiency']) || 0,
                            "Efficiency Alert": String(obj['Efficiency Alert'] || '').trim(),
                            "Best Performing (Cost Decline Rank)": obj['Best Performing (Cost Decline Rank)'] || "",
                            "Expense Growth Alignment": expenseGrowthAlignment,
                            "Marketing Spend Efficiency": String(obj['Marketing Spend Efficiency'] || '').trim(),
                            "Elasticity Classification": String(obj['Elasticity Classification'] || '').trim(),
                            // Growth & Risk Driver columns
                            "# of Months Outpaced Growth": parseFloat(obj['# of Months Outpaced Growth']) || 0,
                            "# of Months Did Not Decline with Profit": parseFloat(obj['# of Months Did Not Decline with Profit']) || 0,
                            "# of Months Opposite Direction than Profit": parseFloat(obj['# of Months Opposite Direction than Profit']) || 0,
                            "Total Excess Costs (5% Buffer)": parseFloat(obj['Total Excess Costs (5% Buffer)']) || 0
                        };
                    });

                    return processedData;
                } catch (error) {
                    console.error('Excel parsing error:', error);
                    throw new Error(`Excel parsing failed: ${error.message}`);
                }
            },

            updateMonthCountDisplay: function() {
                if (!this.rawHeaders) return;
                
                // Count month columns (Jan 2025, Feb 2025, etc.)
                const monthColumns = this.rawHeaders.filter(header => {
                    const headerStr = String(header || '').trim();
                    return /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}$/i.test(headerStr);
                });
                
                const monthCount = monthColumns.length;
                const monthCountElement = document.getElementById('monthCountDisplay');
                if (monthCountElement) {
                    monthCountElement.textContent = `(${monthCount} months)`;
                }
                
                // Update most recent month display for Key Insights section
                const recentMonthElement = document.getElementById('recentMonthDisplay');
                if (recentMonthElement && monthColumns.length > 0) {
                    const lastMonth = monthColumns[monthColumns.length - 1];
                    const monthName = lastMonth.split(' ')[0]; // Extract just the month name
                    
                    // Convert month abbreviation to full name
                    const monthNames = {
                        'Jan': 'January', 'Feb': 'February', 'Mar': 'March', 'Apr': 'April',
                        'May': 'May', 'Jun': 'June', 'Jul': 'July', 'Aug': 'August',
                        'Sep': 'September', 'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
                    };
                    const fullMonthName = monthNames[monthName] || monthName;
                    recentMonthElement.textContent = `(${fullMonthName})`;
                }
                
                console.log(`Found ${monthCount} month columns:`, monthColumns);
                

            },

            loadSampleData: function() {
                this.originalData = [...this.sampleData];
                this.filteredData = [...this.sampleData];
                
                // Create model data by filtering out excluded categories
                this.modelData = this.originalData.filter(item => {
                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                    return hasModelData && isNotExcluded;
                }).map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                }));
                
                this.initializeDashboard();
                this.showUploadSuccess('Sample Data', this.sampleData.length);
            },

            loadPreloadedData: function() {
                console.log('loadPreloadedData called');
                
                // Add cache-busting timestamp to prevent caching
                const timestamp = new Date().getTime();
                
                // Try multiple sources for the Excel file with cache-busting
                const sources = [
                    `/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`,
                    `/public/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`
                ];
                
                const tryFetch = async (url) => {
                    try {
                        console.log('Trying to fetch from:', url);
                        
                        // Add cache-busting headers to prevent any caching
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        console.log('Response status:', response.status);
                        
                        if (response.ok) {
                            const arrayBuffer = await response.arrayBuffer();
                            console.log('Successfully fetched file, parsing...');
                            
                            const data = this.parseExcel(arrayBuffer);
                            if (data && data.length > 0) {
                                console.log('Main data columns:', Object.keys(data[0]));
                                console.log('Growth & Risk columns in main data:');
                                console.log('- # of Months Outpaced Growth:', data[0]['# of Months Outpaced Growth']);
                                console.log('- # of Months Did Not Decline with Profit:', data[0]['# of Months Did Not Decline with Profit']);
                                console.log('- # of Months Opposite Direction than Profit:', data[0]['# of Months Opposite Direction than Profit']);
                                console.log('- Total Excess Costs (5% Buffer):', data[0]['Total Excess Costs (5% Buffer)']);
                                console.log('=== END MAIN DATA DEBUG ===');
                                
                                this.originalData = data;
                                this.filteredData = [...data];
                                
                                // Create model data by filtering out excluded categories
                                this.modelData = data.filter(item => {
                                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                    return hasModelData && isNotExcluded;
                                }).map(item => ({
                                    "Category": item.Category,
                                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                                }));
                                
                                                // Chunk2 data loading removed - using main data only
                                
                                this.initializeDashboard();
                                this.showUploadSuccess('Pre-loaded Data (Fresh)', data.length);
                                return true;
                            }
                        }
                        return false;
                    } catch (error) {
                        console.error('Error fetching from', url, ':', error);
                        return false;
                    }
                };
                
                // Try each source until one works
                const attemptLoad = async () => {
                    for (const source of sources) {
                        const success = await tryFetch(source);
                        if (success) {
                            console.log('Successfully loaded fresh data from:', source);
                            return;
                        }
                    }
                    
                    // If all sources fail, show error
                    console.error('Failed to load data from all sources');
                    this.showUploadError('Failed to load pre-loaded data. Please check your connection and try again.');
                };
                
                attemptLoad();
            },



            initializeDashboard: function() {
                const dashboardContent = document.getElementById('dashboardContent');
                if (dashboardContent) {
                    dashboardContent.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    this.setupFilters();
                    this.updateCharts();
                    this.updateTable();
                    this.updateGrowthRiskTable();
                    
                    setTimeout(() => {
                        this.updateInsights();
                        this.updateMonthCountDisplay();
                        this.calculateProjections();
                        this.isInitialized = true;
                    }, 200);
                }, 100);
            },

            setupFilters: function() {
                // Filter out excluded categories from dropdown options
                const categories = [...new Set(this.originalData
                    .filter(item => !this.isExcludedFromProjections(item.Category))
                    .map(item => item.Category))].sort();
                const marginClassifications = [...new Set(this.originalData.map(item => item['Margin Leverage Classification']))].sort();

                const categoryContainer = document.getElementById('categoryDropdown');
                if (categoryContainer) {
                    let categoryHTML = '';
                    categories.forEach(cat => {
                        const safeId = cat.replace(/[^a-zA-Z0-9]/g, '_');
                        categoryHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="cat_${safeId}" value="${cat}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('categoryDropdown', 'categoryButtonText')">
                                <label for="cat_${safeId}">${cat}</label>
                            </div>
                        `;
                    });
                    categoryContainer.innerHTML = categoryHTML;
                }

                const marginContainer = document.getElementById('marginDropdown');
                if (marginContainer) {
                    let marginHTML = '';
                    marginClassifications.forEach(margin => {
                        const safeId = margin.replace(/[^a-zA-Z0-9]/g, '_');
                        marginHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="margin_${safeId}" value="${margin}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('marginDropdown', 'marginButtonText')">
                                <label for="margin_${safeId}">${margin}</label>
                            </div>
                        `;
                    });
                    marginContainer.innerHTML = marginHTML;
                }

                this.updateDropdownText('categoryDropdown', 'categoryButtonText');
                this.updateDropdownText('marginDropdown', 'marginButtonText');
            },

            toggleDropdown: function(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.classList.toggle('show');
                }
            },

            updateDropdownText: function(dropdownId, buttonTextId) {
                const checkboxes = document.querySelectorAll(`#${dropdownId} input[type="checkbox"]:checked`);
                const buttonText = document.getElementById(buttonTextId);
                
                if (buttonText) {
                    if (checkboxes.length === 0) {
                        buttonText.innerHTML = 'None selected';
                    } else if (checkboxes.length === 1) {
                        buttonText.innerHTML = checkboxes[0].nextElementSibling.textContent;
                    } else {
                        buttonText.innerHTML = `${checkboxes.length} selected <span class="selected-count">${checkboxes.length}</span>`;
                    }
                }
            },

            applyFilters: function() {
                const selectedCategories = Array.from(document.querySelectorAll('#categoryDropdown input:checked')).map(cb => cb.value);
                const selectedMarginClassifications = Array.from(document.querySelectorAll('#marginDropdown input:checked')).map(cb => cb.value);

                this.filteredData = this.originalData.filter(item => 
                    selectedCategories.includes(item.Category) && 
                    selectedMarginClassifications.includes(item['Margin Leverage Classification']) &&
                    !this.isExcludedFromProjections(item.Category)
                );

                this.updateCharts();
                this.updateTable();
                this.updateGrowthRiskTable();
                this.updateMonthCountDisplay();
                
                if (this.isInitialized) {
                    this.updateInsights();
                }
            },

            updateCharts: function() {
                if (this.filteredData.length === 0) return;
                this.updatePerformanceChart();
            },

            updatePerformanceChart: function() {
                // Filter out revenue/income categories from the performance chart
                const chartData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                
                const performanceCounts = {};
                chartData.forEach(item => {
                    const perf = item['Performance Diagnostic Summary'] || 'Unknown';
                    performanceCounts[perf] = (performanceCounts[perf] || 0) + 1;
                });

                const ctx1 = document.getElementById('performanceChart');
                if (!ctx1) return;

                if (this.performanceChart) {
                    this.performanceChart.destroy();
                }

                this.performanceChart = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(performanceCounts),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(performanceCounts),
                            backgroundColor: ['#e53e3e', '#fd7900', '#48bb78', '#4299e1'],
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Math.round(value);
                                    }
                                } 
                            },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            },

            updateTable: function() {
                const table = document.getElementById('dataTable');
                if (!table) return;

                const tbody = table.querySelector('tbody');
                if (!tbody) return;

                // Filter out excluded categories from the table display
                const tableData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from table: "${item.Category}"`);
                    }
                    return !isExcluded &&
                        item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                        item.Category.toLowerCase().trim() !== 'gross profit' &&
                        !item.Category.toLowerCase().trim().includes('400000 management fees');
                });

                // Debug: print keys of first row
                if (tableData.length > 0) {
                    console.log('First row keys in filteredData:', Object.keys(tableData[0]));
                    console.log('First row in filteredData:', tableData[0]);
                }

                if (tableData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                    return;
                }

                const suggestedActionPriority = {
                    'Investigate - Potential Risk': 1,
                    'Efficient Scaling': 2,
                    'Productivity Gain': 3,
                    'Strong Cost Control': 4,
                    'Review Volatility': 5,
                    'No Comparison': 6,
                    'Stable - No Action': 7,
                    'Below Threshold': 8
                };

                const sortedData = [...tableData].sort((a, b) => {
                    const aAction = a['Efficiency Alert'] || 'N/A';
                    const bAction = b['Efficiency Alert'] || 'N/A';
                    const aPriority = suggestedActionPriority[aAction] || 999;
                    const bPriority = suggestedActionPriority[bAction] || 999;
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority;
                    }
                    
                    // Within the same action group, sort by category name
                    return (a.Category || '').localeCompare(b.Category || '');
                });

                let tableHTML = '';
                sortedData.forEach(item => {
                    tableHTML += '<tr>';
                    
                    // Category
                    tableHTML += `<td>${item.Category || 'N/A'}</td>`;
                    
                    // Expenses for Most Recent Month (now from 'Jun 2025')
                    const junExpenses = item['Jun 2025'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(junExpenses).toLocaleString()}</td>`;
                    
                    // Most Recent Month vs. Avg. of Prior Months
                    const anchorPriorValue = item['Anchor vs Prior Avg ($)'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(anchorPriorValue).toLocaleString()}</td>`;
                    
                    // Expense Growth Alignment (as text)
                    const expenseGrowthAlignment = item['Expense Growth Alignment'] || '';
                    console.log(`Table row for ${item.Category}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                    console.log(`Full item for ${item.Category}:`, item);
                    tableHTML += `<td class="center-column">${expenseGrowthAlignment}</td>`;

                    // Suggested Action (using Efficiency Alert)
                    const suggestedAction = item['Efficiency Alert'] || 'N/A';
                    tableHTML += `<td class="center-column">${suggestedAction}</td>`;

                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateInsights: function() {
                // For most insights, filter out excluded categories
                const insightData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category) &&
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                );



                // Expenses Grew Faster Than GP (using Expense Growth Alignment)
                // Use less restrictive filtering for this specific metric
                console.log('=== EXPENSES GREW FASTER THAN GP DEBUG ===');
                console.log('Total filteredData items:', this.filteredData.length);
                
                const outpacedCategories = this.filteredData.filter(item => {
                    const cat = (item.Category || '').toLowerCase().trim();
                    
                    // Debug: Log specific categories we're looking for
                    if (cat.includes('612000') || cat.includes('430000') || cat.includes('medical services') || cat.includes('professional fees')) {
                        console.log(`DEBUG - Category: "${item.Category}", Expense Growth Alignment: "${item['Expense Growth Alignment']}"`);
                    }
                    
                    // Apply only essential exclusions for this metric (remove medical, services, fee, fees)
                    const essentialExclusions = [
                        'net operating income',
                        'total income',
                        'gross profit',
                        'net income',
                        'unapplied cash payment income',
                        'total expenses'
                    ];
                    
                    // Remove the problematic exclusions that are blocking our target categories
                    const essentialPatternExclusions = [
                        // Removed: '400000 management fees', '420000 services - doctors'
                    ];
                    
                    // Check essential exact matches
                    if (essentialExclusions.includes(cat)) {
                        console.log(`Excluding "${item.Category}" due to essential exclusion`);
                        return false;
                    }
                    
                    // Check essential pattern matches
                    for (let pattern of essentialPatternExclusions) {
                        if (cat.includes(pattern)) {
                            console.log(`Excluding "${item.Category}" due to pattern "${pattern}"`);
                            return false;
                        }
                    }
                    
                    // Check if starts with "total" (removed this exclusion)
                    // if (cat.startsWith('total ') && !cat.includes('medical') && !cat.includes('service')) {
                    //     console.log(`Excluding "${item.Category}" due to total exclusion`);
                    //     return false;
                    // }
                    
                    // Check for income/profit exclusions (keep medical/service categories)
                    if (cat.includes('income') || cat.includes('profit')) {
                        console.log(`Excluding "${item.Category}" due to income/profit exclusion`);
                        return false;
                    }
                    
                    // Now check if it has the right Expense Growth Alignment
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    const matches = growthAlignment === 'Expenses Grew Faster Than GP';
                    
                    if (cat.includes('612000') || cat.includes('430000') || cat.includes('medical services') || cat.includes('professional fees')) {
                        console.log(`Category "${item.Category}" - Growth Alignment: "${growthAlignment}", Matches: ${matches}`);
                    }
                    
                    return matches;
                });
                
                console.log('Found categories with Expenses Grew Faster Than GP:', outpacedCategories.map(item => item.Category));
                console.log('=== END EXPENSES GREW FASTER THAN GP DEBUG ===');
                
                const expenseOutpacedElement = document.getElementById('expenseOutpacedText');
                if (expenseOutpacedElement) {
                    if (outpacedCategories.length > 0) {
                        const categoryNames = outpacedCategories.map(item => item.Category);
                        expenseOutpacedElement.textContent = `(${outpacedCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseOutpacedElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Expenses Grew Even Though GP Declined (using Expense Growth Alignment)
                const grewDespiteDeclineCategories = insightData.filter(item => {
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    return growthAlignment === 'Expenses Grew Even Though GP Declined';
                });
                
                const expenseGrewDespiteDeclineElement = document.getElementById('expenseGrewDespiteDeclineText');
                if (expenseGrewDespiteDeclineElement) {
                    if (grewDespiteDeclineCategories.length > 0) {
                        const categoryNames = grewDespiteDeclineCategories.map(item => item.Category);
                        expenseGrewDespiteDeclineElement.textContent = `(${grewDespiteDeclineCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseGrewDespiteDeclineElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Highest variance (exclude income, gross profit, and related categories)
                const topVariance = this.filteredData
                    .filter(item => {
                        const variance = item['Anchor vs Prior Avg ($)'];
                        const cat = (item.Category || '').toLowerCase().trim();
                        return variance !== undefined && variance !== null && variance !== 0 &&
                            cat !== 'net ordinary income' && cat !== 'gross profit' && cat !== 'net ordinary expense' &&
                            !cat.includes('income') && !cat.includes('gross profit') && !cat.includes('profit') &&
                            !cat.includes('revenue') && !cat.includes('fee') && !cat.includes('fees');
                    })
                    .sort((a, b) => Math.abs(b['Anchor vs Prior Avg ($)']) - Math.abs(a['Anchor vs Prior Avg ($)']))[0];
                
                const topVarianceElement = document.getElementById('topVarianceText');
                if (topVarianceElement) {
                    if (topVariance) {
                        const varianceAmount = Math.round(topVariance['Anchor vs Prior Avg ($)']);
                        const sign = varianceAmount >= 0 ? '+' : '-';
                        const formattedVariance = `(${sign}${Math.abs(varianceAmount).toLocaleString()})`;
                        topVarianceElement.textContent = `${topVariance.Category} ${formattedVariance}`;
                    } else {
                        topVarianceElement.textContent = 'No variance data available';
                    }
                }

                // Top 3 Performing Expense Categories - USE ORIGINAL DATA (include Total categories for performance ranking)
                const topPerformingCategories = this.filteredData
                    .filter(item => {
                        const rank = item['Best Performing (Cost Decline Rank)'];
                        return rank === 1 || rank === 2 || rank === 3 || rank === "1" || rank === "2" || rank === "3";
                    })
                    .sort((a, b) => {
                        const aRank = parseInt(a['Best Performing (Cost Decline Rank)']) || 999;
                        const bRank = parseInt(b['Best Performing (Cost Decline Rank)']) || 999;
                        return aRank - bRank;
                    });
                
                const topMarginElement = document.getElementById('topMarginText');
                if (topMarginElement) {
                    if (topPerformingCategories.length > 0) {
                        const formattedList = topPerformingCategories
                            .map((item) => `${parseInt(item['Best Performing (Cost Decline Rank)'])}. ${item.Category}`)
                            .join(', ');
                        topMarginElement.textContent = formattedList;
                    } else {
                        topMarginElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Marketing Spend Efficiency - include 614000 Marketing & Advertising, Total 614000 Marketing, Advertising, and 614200 Internet & Social media
                const marketingEfficiencyCategories = this.filteredData.filter(item => {
                    const efficiency = item['Marketing Spend Efficiency'];
                    const hasEfficiencyData = efficiency && efficiency.toString().trim() !== '';
                    const cat = (item.Category || '').toLowerCase().trim();
                    const isMarketingSpecial = cat === '614000 marketing & advertising' || 
                                             cat === 'total 614000 marketing' || 
                                             cat === 'advertising' || 
                                             cat === '614200 internet & social media';
                    // Include the specific marketing categories
                    return hasEfficiencyData && isMarketingSpecial;
                });
                const roiElement = document.getElementById('marketingROIText');
                if (roiElement) {
                    if (marketingEfficiencyCategories.length > 0) {
                        const formattedList = marketingEfficiencyCategories
                            .map(item => `${item.Category} (${item['Marketing Spend Efficiency']})`)
                            .join(', ');
                        roiElement.textContent = formattedList;
                    } else {
                        roiElement.textContent = 'No marketing efficiency data available';
                    }
                }


            },

            calculateProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                // Calculate projections for all model data, excluding Net Ordinary Income and Gross Profit
                const projections = this.modelData.filter(item =>
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                ).map(item => {
                    const projectedExpense = item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP);
                    return {
                        ...item,
                        "Projected Expense": Math.round(Math.max(0, projectedExpense))
                    };
                });

                const totalProjectedExpenses = projections.reduce((sum, item) => sum + item["Projected Expense"], 0);
                const projectedProfit = estimatedGP - totalProjectedExpenses;

                const totalExpensesElement = document.getElementById('totalProjectedExpenses');
                const projectedProfitElement = document.getElementById('projectedProfit');
                
                if (totalExpensesElement) {
                    totalExpensesElement.textContent = `$${totalProjectedExpenses.toLocaleString()}`;
                }
                
                if (projectedProfitElement) {
                    projectedProfitElement.textContent = `$${projectedProfit.toLocaleString()}`;
                    projectedProfitElement.style.color = projectedProfit >= 0 ? '#48bb78' : '#f56565';
                }

                this.updateProjectionsTable(projections);
                this.updateTopDriversTable(projections);
            },

            updateProjectionsTable: function(projections) {
                const tbody = document.querySelector('#projectionTable tbody');
                if (!tbody) return;
                
                let tableHTML = '';
                projections.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${Math.round(item["Fixed Cost Estimate"]).toLocaleString()}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¬¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateTopDriversTable: function(projections) {
                const tbody = document.querySelector('#topDriversTable tbody');
                if (!tbody) return;
                
                const topDrivers = projections
                    .filter(item => item["Marginal Cost per $1 GP"] > 0)
                    .sort((a, b) => b["Marginal Cost per $1 GP"] - a["Marginal Cost per $1 GP"])
                    .slice(0, 5);
                
                let tableHTML = '';
                topDrivers.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¬¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateGrowthRiskTable: function() {
                const table = document.getElementById('growthRiskTable');
                if (!table) return;
                const tbody = table.querySelector('tbody');
                if (!tbody) return;
                
                // Use main data (expense-analysis.xlsx) for all metrics
                let mainData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from Growth & Risk Drivers: "${item.Category}"`);
                    }
                    return !isExcluded;
                }) || [];
                
                // Sort by Potential $ Loss Due to Excess Spending (highest to lowest)
                mainData.sort((a, b) => {
                    let aExcessCost = 0;
                    let bExcessCost = 0;
                    
                    // Try to find excess cost values for both items
                    const possibleExcessColumns = [
                        'Total Excess Costs (5% Buffer)',
                        'Excess Costs (5% Buffer)',
                        'Total Excess Costs',
                        'Excess Costs',
                        'Potential Loss',
                        'Excess Spending'
                    ];
                    
                    for (const colName of possibleExcessColumns) {
                        if (a[colName] !== undefined && a[colName] !== null && a[colName] !== '') {
                            aExcessCost = Number(a[colName]);
                            break;
                        }
                    }
                    
                    for (const colName of possibleExcessColumns) {
                        if (b[colName] !== undefined && b[colName] !== null && b[colName] !== '') {
                            bExcessCost = Number(b[colName]);
                            break;
                        }
                    }
                    
                    return bExcessCost - aExcessCost; // Highest to lowest
                });
                
                // Debug logging
                console.log('=== GROWTH RISK DEBUG ===');
                console.log('Main data available:', mainData.length > 0);
                if (mainData.length > 0) {
                    console.log('First main data item:', mainData[0]);
                    console.log('Main data columns:', Object.keys(mainData[0]));
                    
                    // Log all column names to help identify the correct ones
                    const allColumns = Object.keys(mainData[0]);
                    console.log('All available columns in main data:', allColumns);
                    
                    // Look for columns that might contain the data we need
                    const excessCostColumns = allColumns.filter(col => 
                        col.toLowerCase().includes('excess') || 
                        col.toLowerCase().includes('cost') || 
                        col.toLowerCase().includes('loss') ||
                        col.toLowerCase().includes('buffer')
                    );
                    console.log('Potential excess cost columns:', excessCostColumns);
                    
                    // Look for the specific columns we need for month counts
                    const monthCountColumns = allColumns.filter(col => 
                        col.toLowerCase().includes('months') || 
                        col.toLowerCase().includes('outpaced') ||
                        col.toLowerCase().includes('decline') ||
                        col.toLowerCase().includes('opposite')
                    );
                    console.log('Potential month count columns:', monthCountColumns);
                    
                    // Check for exact matches
                    console.log('Looking for exact column matches:');
                    console.log('  "# of Months Outpaced Growth":', allColumns.includes('# of Months Outpaced Growth'));
                    console.log('  "# of Months Did Not Decline with Profit":', allColumns.includes('# of Months Did Not Decline with Profit'));
                    console.log('  "# of Months Opposite Direction than Profit":', allColumns.includes('# of Months Opposite Direction than Profit'));
                }
                console.log('=== END GROWTH RISK DEBUG ===');
                
                let tableHTML = '';
                let hasData = false;
                
                mainData.forEach(item => {
                    // Use main data directly for all metrics
                    const dataSource = item;
                    
                    // Try to find the correct column names for excess costs
                    let excessCostValue = 0;
                    if (dataSource) {
                        // Try multiple possible column names for excess costs
                        const possibleExcessColumns = [
                            'Total Excess Costs (5% Buffer)',
                            'Excess Costs (5% Buffer)',
                            'Total Excess Costs',
                            'Excess Costs',
                            'Potential Loss',
                            'Excess Spending'
                        ];
                        
                        for (const colName of possibleExcessColumns) {
                            if (dataSource[colName] !== undefined && dataSource[colName] !== null && dataSource[colName] !== '') {
                                excessCostValue = Number(dataSource[colName]);
                                console.log(`Found excess cost value for ${item.Category} in column "${colName}":`, excessCostValue);
                                break;
                            }
                        }
                    }
                    
                    // Get month count values from main data
                    const outpacedGrowth = dataSource['# of Months Outpaced Growth'];
                    const didNotDecline = dataSource['# of Months Did Not Decline with Profit'];
                    const oppositeDirection = dataSource['# of Months Opposite Direction than Profit'];
                    

                    
                    // Check if we have any meaningful data
                    if (outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' && outpacedGrowth > 0) {
                        hasData = true;
                    }
                    if (didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' && didNotDecline > 0) {
                        hasData = true;
                    }
                    if (oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' && oppositeDirection > 0) {
                        hasData = true;
                    }
                    if (excessCostValue > 0) {
                        hasData = true;
                    }
                    
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item['Category'] || 'N/A'}</td>`;
                    tableHTML += `<td class="center-column">${outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' ? Number(outpacedGrowth).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' ? Number(didNotDecline).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' ? Number(oppositeDirection).toFixed(0) : '0'}</td>`;
                    tableHTML += `<td class="center-column">${excessCostValue > 0 ? '$' + Math.round(excessCostValue).toLocaleString() : '$0'}</td>`;
                    tableHTML += '</tr>';
                });
                
                // If no meaningful data found, show a message
                if (!hasData) {
                    tableHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #718096; font-style: italic;">Growth & Risk Drivers data not available. This section requires additional data that may not be present in the current file.</td></tr>';
                }
                
                tbody.innerHTML = tableHTML;
            },

            exportFilteredData: function() {
                const exportData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_filtered.csv');
            },

            exportAllData: function() {
                const exportData = this.originalData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_complete.csv');
            },

            exportProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                const projections = this.modelData.map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": Math.round(item["Fixed Cost Estimate"]),
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"],
                    "Projected Expense": Math.round(item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP)),
                    "Estimated Gross Profit": estimatedGP
                }));

                this.exportData(projections, `expense_projections_${estimatedGP.toLocaleString()}_gp.csv`);
            },

            exportData: function(dataToExport, fileName) {
                if (dataToExport.length === 0) {
                    alert('No data available to export');
                    return;
                }

                const headers = Object.keys(dataToExport[0]);
                const csvContent = [
                    headers.join(','),
                    ...dataToExport.map(row => 
                        headers.map(header => {
                            let value = row[header];
                            if (typeof value === 'number') {
                                value = Math.round(value);
                            }
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                value = `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Data exported successfully as ${fileName}`);
            },

            showUploadSuccess: function(fileName, recordCount) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status">
                            <h3>‚úÖ Data Loaded Successfully!</h3>
                            <p><strong>File:</strong> ${fileName}</p>
                            <p><strong>Records loaded:</strong> ${recordCount}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer;">Upload Different File</button>
                        </div>
                    `;
                }
            },

            showUploadError: function(errorMessage) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status error">
                            <h3>‚ùå Upload Error</h3>
                            <p>${errorMessage}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                }
            },

            loadStatusSummaryData: function() {
                const fileName = 'Status Summary Source File.xlsx';
                const publicPath = `/public/${fileName}`;
                const rootPath = `/${fileName}`;
                const sources = [publicPath, rootPath];
                const statusSummaryDiv = document.getElementById('statusSummaryItems');
                if (statusSummaryDiv) statusSummaryDiv.innerHTML = '<span>Loading...</span>';

                const tryFetch = async (url) => {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) return false;
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        if (jsonData && jsonData.length > 0) {
                            this.statusSummaryData = jsonData;
                            this.renderStatusSummary();
                            this.renderStatusSummaryChart();
                            return true;
                        }
                    } catch (e) {
                        return false;
                    }
                    return false;
                };

                (async () => {
                    for (const src of sources) {
                        const ok = await tryFetch(src);
                        if (ok) return;
                    }
                    if (statusSummaryDiv) statusSummaryDiv.innerHTML = '<span style="color:#e53e3e">No summary data found.</span>';
                })();
            },

            renderStatusSummary: function() {
                const statusSummaryDiv = document.getElementById('statusSummaryItems');
                if (!statusSummaryDiv) return;
                const data = this.statusSummaryData || [];
                if (!data.length) {
                    statusSummaryDiv.innerHTML = '<span>No summary data available.</span>';
                    return;
                }
                let html = '<ul style="padding-left:20px;line-height:1.7;">';
                data.forEach(row => {
                    Object.entries(row).forEach(([k, v]) => {
                        html += `<li><strong>${k}:</strong> ${v}</li>`;
                    });
                });
                html += '</ul>';
                statusSummaryDiv.innerHTML = html;
            },

            renderStatusSummaryChart: function() {
                console.log('=== SIMPLE CHART FUNCTION START ===');
                
                // Hardcode the data we know works
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'July'];
                const revenueData = [141764, 115153, 144090, 147081, 81394, 138129, 165652];
                
                console.log('Using hardcoded data:', { months, revenueData });
                
                const ctx = document.getElementById('statusSummaryChart');
                if (!ctx) {
                    console.error('Canvas not found!');
                    return;
                }
                
                // Clear any existing content
                ctx.parentElement.innerHTML = '<canvas id="statusSummaryChart" width="650" height="520"></canvas>';
                const newCtx = document.getElementById('statusSummaryChart');
                
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded!');
                    newCtx.parentElement.innerHTML = '<div style="color:red;padding:20px;">Chart.js library not loaded!</div>';
                    return;
                }
                
                try {
                    console.log('Creating simple chart...');
                    const chart = new Chart(newCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Revenue (2025 Gross Profit)',
                                data: revenueData,
                                backgroundColor: '#667eea'
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                    console.log('Chart created successfully!');
                    
                    // Store the chart instance
                    window.statusSummaryChartInstance = chart;
                    
                } catch (error) {
                    console.error('Chart creation failed:', error);
                    newCtx.parentElement.innerHTML = '<div style="color:red;padding:20px;">Chart failed: ' + error.message + '</div>';
                }
                
                // Now create the margin chart
                this.renderMarginSummaryChart();
            },

            renderMarginSummaryChart: function() {
                console.log('=== SIMPLE MARGIN CHART FUNCTION START ===');
                
                // Hardcode the margin data we know works
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'July'];
                const margin2025 = [8.8, 8.4, 20.4, 36.0, -59.7, 21.3, 36.0];
                const margin2024 = [5.0, -10.2, -194.4, -8.3, -11.3, -0.7, -42.9];
                
                console.log('Using hardcoded margin data:', { months, margin2025, margin2024 });
                
                const ctx = document.getElementById('marginSummaryChart');
                if (!ctx) {
                    console.error('Margin canvas not found!');
                    return;
                }
                
                // Clear any existing content
                ctx.parentElement.innerHTML = '<canvas id="marginSummaryChart" width="650" height="520"></canvas>';
                const newCtx = document.getElementById('marginSummaryChart');
                
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded!');
                    newCtx.parentElement.innerHTML = '<div style="color:red;padding:20px;">Chart.js library not loaded!</div>';
                    return;
                }
                
                try {
                    console.log('Creating margin chart...');
                    const chart = new Chart(newCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: '2025 Margin',
                                    data: margin2025,
                                    backgroundColor: '#8ec6fd'
                                },
                                {
                                    label: '2024 Margin',
                                    data: margin2024,
                                    backgroundColor: '#fdc88e'
                                }
                            ]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                    console.log('Margin chart created successfully!');
                    
                    // Store the chart instance
                    window.marginSummaryChartInstance = chart;
                    
                } catch (error) {
                    console.error('Margin chart creation failed:', error);
                    newCtx.parentElement.innerHTML = '<div style="color:red;padding:20px;">Margin chart failed: ' + error.message + '</div>';
                }
            },

        // Load financial performance data
            loadFinancialPerformanceData: async function() {
                try {
                    console.log('Attempting to load Financial Performance Data.xlsx...');
                    // Try to load from API endpoint first, then fallback to direct file access
                    let response;
                    try {
                        console.log('Trying API endpoint: /api/financial-performance');
                        response = await fetch('/api/financial-performance');
                        if (response.ok) {
                            console.log('Success with API endpoint');
                        } else {
                            throw new Error(`API endpoint failed: ${response.status}`);
                        }
                    } catch (apiError) {
                        console.log('API endpoint failed, trying direct file access...');
                        // Fallback to direct file access
                        const possiblePaths = [
                            '/public/Financial Performance Data.xlsx',
                            '/Financial Performance Data.xlsx',
                            '/Financial%20Performance%20Data.xlsx',
                            'Financial Performance Data.xlsx'
                        ];
                        
                        for (const path of possiblePaths) {
                            try {
                                console.log('Trying path:', path);
                                response = await fetch(path);
                                if (response.ok) {
                                    console.log('Success with path:', path);
                                    break;
                                }
                            } catch (e) {
                                console.log('Failed with path:', path, e);
                            }
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw new Error(`HTTP error! status: ${response?.status || 'No response'}`);
                    }
                    
                    console.log('Response status:', response.status);
                    const arrayBuffer = await response.arrayBuffer();
                    console.log('Array buffer size:', arrayBuffer.byteLength);
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    this.financialPerformanceData = XLSX.utils.sheet_to_json(worksheet);
                    console.log('Financial Performance Data loaded:', this.financialPerformanceData);
                    this.renderFinancialPerformanceSection();
                } catch (error) {
                    console.error('Error loading financial performance data:', error);
                    console.log('Falling back to sample data...');
                    // Use fallback data if file not found
                    this.renderFinancialPerformanceSectionWithFallback();
                }
            },

            // Render financial performance section with source file data only
            renderFinancialPerformanceSectionWithFallback: function() {
                console.log('Rendering financial performance section with source file data only...');
                
                // If no source data is available, show a message instead of fallback data
                if (!this.financialPerformanceData || this.financialPerformanceData.length === 0) {
                    console.log('No financial performance data available - please ensure source file is loaded');
                    return;
                }
                
                // Process the source data using the correct function
                this.renderFinancialPerformanceSection();
            },

            // Render financial performance section
            renderFinancialPerformanceSection: function() {
                if (!this.financialPerformanceData || this.financialPerformanceData.length === 0) {
                    this.renderFinancialPerformanceSectionWithFallback();
                    return;
                }

                // Process the new data structure
                const expenseAnalysisData = [];
                const cashflowData = [];
                
                console.log('=== FINANCIAL PERFORMANCE DATA DEBUG ===');
                console.log('Total rows in financialPerformanceData:', this.financialPerformanceData.length);
                console.log('Sample rows:', this.financialPerformanceData.slice(0, 3));
                
                this.financialPerformanceData.forEach(row => {
                    console.log(`Processing row: Category="${row.Category}", Metric_Name="${row.Metric_Name}"`);
                    
                    if (row.Category === 'YOY Expense & Profitability Analysis') {
                        const val2024 = parseFloat(row.Value_2024_Jan_July) || 0;
                        const val2025 = parseFloat(row.Value_2025_Jan_July) || 0;
                        let growth = parseFloat(row.Growth_Rate_Decimal) || 0;
                        
                        // Special handling for Profit per Visit: if prior year is negative and current year is positive,
                        // multiply the growth by -1 to make it positive
                        if (row.Metric_Name === 'Profit per Visit' && val2024 < 0 && val2025 > 0) {
                            growth = Math.abs(growth);
                        }
                        
                        expenseAnalysisData.push({
                            title: row.Metric_Name,
                            responsibility: row.Responsibility,
                            val2024: val2024,
                            val2025: val2025,
                            growth: growth
                        });
                    } else if (row.Category === 'Remaining Year Cashflow Projections') {
                        console.log(`Found cashflow row: ${row.Metric_Name}`);
                        // Handle cashflow data - need to group by month
                        const month = this.extractMonthFromMetricName(row.Metric_Name);
                        console.log(`Extracted month: ${month} from "${row.Metric_Name}"`);
                        
                        if (month) {
                            let cashflowItem = cashflowData.find(item => item.month === month);
                            if (!cashflowItem) {
                                cashflowItem = { month: month, visitAvg: 0, visitProj: 0, expenses: 0, revenue: 0, profit: 0, cashPosition: 0 };
                                cashflowData.push(cashflowItem);
                                console.log(`Created new cashflow item for month: ${month}`);
                            }
                            
                            // Map the data based on metric name
                            if (row.Metric_Name.includes('Visit Average')) {
                                cashflowItem.visitAvg = parseFloat(row.Value_2024_Jan_July) || 0;
                                console.log(`Set visitAvg for ${month}: ${cashflowItem.visitAvg}`);
                            } else if (row.Metric_Name.includes('Visit Projection')) {
                                cashflowItem.visitProj = parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set visitProj for ${month}: ${cashflowItem.visitProj}`);
                            } else if (row.Metric_Name.includes('Expected Expenses')) {
                                cashflowItem.expenses = parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set expenses for ${month}: ${cashflowItem.expenses}`);
                            } else if (row.Metric_Name.includes('Expected Revenue')) {
                                cashflowItem.revenue = parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set revenue for ${month}: ${cashflowItem.revenue}`);
                            } else if (row.Metric_Name.includes('Expected Profit')) {
                                cashflowItem.profit = parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set profit for ${month}: ${cashflowItem.profit}`);
                            } else if (row.Metric_Name.includes('Cash Position')) {
                                cashflowItem.cashPosition = parseFloat(row.Value_2025_Jan_July) || 0;
                                console.log(`Set cashPosition for ${month}: ${cashflowItem.cashPosition}`);
                            }
                        } else {
                            console.log(`Could not extract month from: "${row.Metric_Name}"`);
                        }
                    }
                });
                
                console.log('Final expenseAnalysisData:', expenseAnalysisData);
                console.log('Final cashflowData:', cashflowData);
                console.log('=== END FINANCIAL PERFORMANCE DATA DEBUG ===');

                // Sort cashflow data by month order
                const monthOrder = ['August', 'September', 'October', 'November', 'December'];
                cashflowData.sort((a, b) => monthOrder.indexOf(a.month) - monthOrder.indexOf(b.month));

                this.renderExpenseAnalysisTable(expenseAnalysisData);
                this.renderCashflowTable(cashflowData);
                this.updateKeyMetrics(expenseAnalysisData);
            },

            // Extract month from metric name
            extractMonthFromMetricName: function(metricName) {
                const months = ['August', 'September', 'October', 'November', 'December'];
                for (const month of months) {
                    if (metricName.includes(month)) {
                        return month;
                    }
                }
                return null;
            },

            // Format currency values
            formatCurrency: function(value) {
                if (Math.abs(value) >= 1000000) {
                    return `$${Math.round(value / 1000000)}M`;
                } else if (Math.abs(value) >= 1000) {
                    return `$${Math.round(value / 1000)}K`;
                } else {
                    return `$${Math.round(value)}`;
                }
            },

            // Format visit count values
            formatVisitCount: function(value) {
                return value.toString();
            },

            // Format growth percentage
            formatGrowth: function(growth) {
                const percentage = (growth * 100).toFixed(0);
                const isPositive = growth >= 0;
                const arrow = isPositive ? '‚Üó' : '‚Üò';
                const color = isPositive ? '#38a169' : '#e53e3e';
                return `<div style="color: ${color}; display: flex; align-items: center; justify-content: center;"><span style="margin-right: 5px;">${arrow}</span>${percentage}%</div>`;
            },

            // Get responsibility color class
            getResponsibilityColor: function(responsibility) {
                const colors = {
                    "Team": "bg-blue-100 text-blue-800",
                    "Owner Controlled": "bg-purple-100 text-purple-800", 
                    "RCM/Marketing": "bg-green-100 text-green-800",
                    "Ops - Clinical Administrator Controlled": "bg-orange-100 text-orange-800",
                    "% of visits/revenue": "bg-gray-100 text-gray-800"
                };
                return colors[responsibility] || "bg-gray-100 text-gray-800";
            },

            // Get responsibility color style for inline styling
            getResponsibilityColorStyle: function(responsibility) {
                const colors = {
                    "Team": "background-color: #dbeafe; color: #1e40af;",
                    "Owner Controlled": "background-color: #f3e8ff; color: #7c3aed;", 
                    "RCM/Marketing": "background-color: #dcfce7; color: #166534;",
                    "Ops - Clinical Administrator Controlled": "background-color: #fed7aa; color: #c05621;",
                    "% of visits/revenue": "background-color: #f7fafc; color: #4a5568;"
                };
                return colors[responsibility] || "background-color: #f7fafc; color: #4a5568;";
            },

            // Render expense analysis table
            renderExpenseAnalysisTable: function(data) {
                const tbody = document.querySelector('#expenseAnalysisTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e2e8f0';
                    row.innerHTML = `
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem; color: #2d3748;">
                            <div style="font-weight: 600;">${item.title}</div>
                        </td>
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem;">
                            <span style="display: inline-flex; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; border-radius: 12px; ${this.getResponsibilityColorStyle(item.responsibility)}">
                                ${item.responsibility}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2024) : 
                                this.formatCurrency(item.val2024)
                            }
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2025) : 
                                this.formatCurrency(item.val2025)
                            }
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem;">
                            ${this.formatGrowth(item.growth)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Render cashflow table
            renderCashflowTable: function(data) {
                const tbody = document.querySelector('#cashflowTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e2e8f0';
                    row.innerHTML = `
                        <td style="padding: 12px; text-align: left; font-size: 0.9rem; color: #2d3748;">
                            <div style="font-weight: 600;">${item.month}</div>
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatVisitCount(item.visitAvg)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatVisitCount(item.visitProj)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatCurrency(item.expenses)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748;">
                            ${this.formatCurrency(item.revenue)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #38a169; font-weight: 600;">
                            ${this.formatCurrency(item.profit)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-size: 0.9rem; color: #2d3748; font-weight: 700;">
                            ${this.formatCurrency(item.cashPosition)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Update key metrics display
            updateKeyMetrics: function(data) {
                const revenueItem = data.find(item => item.title === 'Total Revenue');
                const expensesItem = data.find(item => item.title === 'Total Expenses');
                const visitItem = data.find(item => item.title === 'Visit Count');
                const profitItem = data.find(item => item.title === 'Profit per Visit');

                if (revenueItem) {
                    document.getElementById('totalRevenue').textContent = this.formatCurrency(revenueItem.val2025);
                }
                if (expensesItem) {
                    document.getElementById('totalExpenses').textContent = this.formatCurrency(expensesItem.val2025);
                }
                if (visitItem) {
                    document.getElementById('visitCount').textContent = this.formatVisitCount(visitItem.val2025);
                }
                if (profitItem) {
                    document.getElementById('profitPerVisit').textContent = this.formatCurrency(profitItem.val2025);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded at:', new Date().toISOString());
            window.dashboard.init();
            // Automatically load pre-loaded data
            window.dashboard.loadPreloadedData();
            window.dashboard.loadStatusSummaryData();
            window.dashboard.loadFinancialPerformanceData();
        });
    </script>
</body>
</html>
